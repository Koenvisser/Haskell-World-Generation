<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | The wave function collapse algorithm is a way to generate a tilemap based on a set of rules.</span><span>
</span><span id="line-2"></span><span class="hs-comment">--   The algorithm works by starting with a completely empty tilemap and then collapsing the wave function</span><span>
</span><span id="line-3"></span><span class="hs-comment">--   of each tile based on the rules and the surrounding tiles. This is done until the entire tilemap is filled.</span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Gen.WaveFuncCollapse</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Def.html"><span class="hs-identifier">Def</span></a></span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Debug.Trace</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">trace</span></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="annot"><span class="hs-comment">-- | Weights is a tuple of a float and a list of floats (Total weight, [Weights])</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">type</span><span> </span><span id="Weights"><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-var">Weights</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">type</span><span> </span><span id="ShannonEntropy"><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-var">ShannonEntropy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">type</span><span> </span><span id="Env"><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-var">Env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-type">ShannonEntropy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-comment">-- | Initialize the wave function collapse algorithm with a list of tiles and a size for the world.</span><span>
</span><span id="line-19"></span><span class="hs-comment">--   The algorithm will then generate a tilemap and an environemnt using the `createEnv` function.</span><span>
</span><span id="line-20"></span><span class="hs-comment">--   If no Environment can be created with the current Tile set, the function throw an error.</span><span>
</span><span id="line-21"></span><span class="hs-comment">--   Afterwards it will invoke `waveFuncCollapse'` which will iteratiively collapse the wave function. </span><span>
</span><span id="line-22"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse"><span class="hs-identifier hs-type">waveFuncCollapse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Def.html#Size"><span class="hs-identifier hs-type">Size</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span>
</span><span id="line-23"></span><span id="waveFuncCollapse"><span class="annot"><span class="annottext">waveFuncCollapse :: [Tile] -&gt; Size -&gt; IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse"><span class="hs-identifier hs-var hs-var">waveFuncCollapse</span></a></span></span><span> </span><span id="local-6989586621679055419"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span id="local-6989586621679055420"><span class="annot"><span class="annottext">size :: Size
</span><a href="#local-6989586621679055420"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679055421"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055421"><span class="hs-identifier hs-var">minX</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055422"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055422"><span class="hs-identifier hs-var">minY</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055423"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055423"><span class="hs-identifier hs-var">minZ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679055424"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055424"><span class="hs-identifier hs-var">maxX</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055425"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055425"><span class="hs-identifier hs-var">maxY</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055426"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055426"><span class="hs-identifier hs-var">maxZ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679055431"><span class="annot"><span class="annottext">allPos :: [Pos]
</span><a href="#local-6989586621679055431"><span class="hs-identifier hs-var hs-var">allPos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055432"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055433"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055434"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679055432"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055432"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055421"><span class="hs-identifier hs-var">minX</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055424"><span class="hs-identifier hs-var">maxX</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055433"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055433"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055422"><span class="hs-identifier hs-var">minY</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055425"><span class="hs-identifier hs-var">maxY</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055434"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055434"><span class="hs-identifier hs-var">z</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055423"><span class="hs-identifier hs-var">minZ</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055426"><span class="hs-identifier hs-var">maxZ</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679055435"><span class="annot"><span class="annottext">emptyTileMap :: TileMap
</span><a href="#local-6989586621679055435"><span class="hs-identifier hs-var hs-var">emptyTileMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Pos Tile -&gt; TileMap
</span><a href="Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; TileMap -&gt; [Pos] -&gt; Maybe (TileMap, Env)
</span><a href="Gen.WaveFuncCollapse.html#createEnv"><span class="hs-identifier hs-var">createEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679055435"><span class="hs-identifier hs-var">emptyTileMap</span></a></span><span> </span><span class="annot"><span class="annottext">[Pos]
</span><a href="#local-6989586621679055431"><span class="hs-identifier hs-var">allPos</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IO TileMap
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;No possible tilemap&quot;</span></span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679055439"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679055439"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055440"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055440"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; TileMap -&gt; Env -&gt; IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-var">waveFuncCollapse'</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679055439"><span class="hs-identifier hs-var">tileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055440"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-comment">-- | Create the tileMap and environment for the wave function collapse algorithm</span><span>
</span><span id="line-31"></span><span class="hs-comment">--   It applies the rule to each position and creates the environment based on the result.</span><span>
</span><span id="line-32"></span><span class="hs-comment">--   If an environment only has one possible tile it will be added to the tileMap, </span><span>
</span><span id="line-33"></span><span class="hs-comment">--   and removed from the environment. If an environment has no possible tiles, the function will return Nothing.</span><span>
</span><span id="line-34"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#createEnv"><span class="hs-identifier hs-type">createEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span id="createEnv"><span class="annot"><span class="annottext">createEnv :: [Tile] -&gt; TileMap -&gt; [Pos] -&gt; Maybe (TileMap, Env)
</span><a href="Gen.WaveFuncCollapse.html#createEnv"><span class="hs-identifier hs-var hs-var">createEnv</span></a></span></span><span> </span><span id="local-6989586621679055441"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055441"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span id="local-6989586621679055442"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679055442"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Pos -&gt; Maybe (TileMap, Env) -&gt; Maybe (TileMap, Env))
-&gt; Maybe (TileMap, Env) -&gt; [Pos] -&gt; Maybe (TileMap, Env)
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679055444"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679055444"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621679055445"><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><a href="#local-6989586621679055445"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><a href="#local-6989586621679055445"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><span id="line-36"></span><span>  </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-37"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span id="local-6989586621679055446"><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679055446"><span class="hs-identifier hs-var">newTileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055447"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055447"><span class="hs-identifier hs-var">newEnv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Maybe (Either Tile ([Tile], Weights, Float))
</span><a href="#local-6989586621679055448"><span class="hs-identifier hs-var">posToEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679055444"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Either Tile ([Tile], Weights, Float))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679055449"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679055449"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TileMap, Env) -&gt; Maybe (TileMap, Env)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile -&gt; TileMap
</span><a href="Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Pos Tile -&gt; TileMap) -&gt; Map Pos Tile -&gt; TileMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Tile -&gt; Map Pos Tile -&gt; Map Pos Tile
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679055444"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679055449"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679055446"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055447"><span class="hs-identifier hs-var">newEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679055451"><span class="annot"><span class="annottext">([Tile], Weights, Float)
</span><a href="#local-6989586621679055451"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TileMap, Env) -&gt; Maybe (TileMap, Env)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile -&gt; TileMap
</span><a href="Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679055446"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; ([Tile], Weights, Float) -&gt; Env -&gt; Env
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679055444"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">([Tile], Weights, Float)
</span><a href="#local-6989586621679055451"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055447"><span class="hs-identifier hs-var">newEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TileMap, Env) -&gt; Maybe (TileMap, Env)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679055442"><span class="hs-identifier hs-var">tileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><a href="#local-6989586621679055448"><span class="hs-identifier hs-type">posToEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-type">ShannonEntropy</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-44"></span><span>    </span><span id="local-6989586621679055448"><span class="annot"><span class="annottext">posToEnv :: Pos -&gt; Maybe (Either Tile ([Tile], Weights, Float))
</span><a href="#local-6989586621679055448"><span class="hs-identifier hs-var hs-var">posToEnv</span></a></span></span><span> </span><span id="local-6989586621679055452"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679055452"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-45"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679055453"><span class="annot"><span class="annottext">weights :: [Float]
</span><a href="#local-6989586621679055453"><span class="hs-identifier hs-var hs-var">weights</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Tile -&gt; Float) -&gt; [Tile] -&gt; [Float]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleResult -&gt; Float
</span><a href="Def.html#resultToFloat"><span class="hs-identifier hs-var">resultToFloat</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleResult -&gt; Float) -&gt; (Tile -&gt; RuleResult) -&gt; Tile -&gt; Float
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Def.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span id="local-6989586621679055457"><span class="annot"><span class="annottext">TileMap -&gt; Pos -&gt; RuleResult
</span><a href="#local-6989586621679055457"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TileMap -&gt; Pos -&gt; RuleResult
</span><a href="#local-6989586621679055457"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679055442"><span class="hs-identifier hs-var">tileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679055452"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Rule -&gt; RuleResult) -&gt; (Tile -&gt; Rule) -&gt; Tile -&gt; RuleResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Tile -&gt; Rule
</span><a href="Def.html#rules"><span class="hs-identifier hs-var">rules</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055441"><span class="hs-identifier hs-var">tiles</span></a></span><span>
</span><span id="line-46"></span><span>          </span><span id="local-6989586621679055461"><span class="annot"><span class="annottext">newTiles :: [Tile]
</span><a href="#local-6989586621679055461"><span class="hs-identifier hs-var hs-var">newTiles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Tile, Float) -&gt; Tile) -&gt; [(Tile, Float)] -&gt; [Tile]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Tile, Float) -&gt; Tile
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Tile, Float)] -&gt; [Tile]) -&gt; [(Tile, Float)] -&gt; [Tile]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Tile, Float) -&gt; Bool) -&gt; [(Tile, Float)] -&gt; [(Tile, Float)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tile
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055463"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055463"><span class="hs-identifier hs-var">weight</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055463"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Tile, Float)] -&gt; [(Tile, Float)])
-&gt; [(Tile, Float)] -&gt; [(Tile, Float)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; [Float] -&gt; [(Tile, Float)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055441"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679055453"><span class="hs-identifier hs-var">weights</span></a></span><span>
</span><span id="line-47"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055461"><span class="hs-identifier hs-var">newTiles</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-48"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Either Tile ([Tile], Weights, Float))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-49"></span><span>        </span><span class="hs-special">[</span><span id="local-6989586621679055465"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679055465"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Tile ([Tile], Weights, Float)
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Either Tile ([Tile], Weights, Float)
 -&gt; Maybe (Either Tile ([Tile], Weights, Float)))
-&gt; Either Tile ([Tile], Weights, Float)
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tile -&gt; Either Tile ([Tile], Weights, Float)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679055465"><span class="hs-identifier hs-var">tile</span></a></span><span>
</span><span id="line-50"></span><span>        </span><span class="annot"><span class="annottext">[Tile]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>      </span><span>
</span><span id="line-51"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679055468"><span class="annot"><span class="annottext">totWeight :: Float
</span><a href="#local-6989586621679055468"><span class="hs-identifier hs-var hs-var">totWeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Float] -&gt; Float
forall a. Num a =&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679055453"><span class="hs-identifier hs-var">weights</span></a></span><span>
</span><span id="line-52"></span><span>          </span><span class="annot"><span class="annottext">Either Tile ([Tile], Weights, Float)
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Either Tile ([Tile], Weights, Float)
 -&gt; Maybe (Either Tile ([Tile], Weights, Float)))
-&gt; Either Tile ([Tile], Weights, Float)
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([Tile], Weights, Float) -&gt; Either Tile ([Tile], Weights, Float)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055461"><span class="hs-identifier hs-var">newTiles</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055468"><span class="hs-identifier hs-var">totWeight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679055453"><span class="hs-identifier hs-var">weights</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights -&gt; Float
</span><a href="Gen.WaveFuncCollapse.html#shannonEntropy"><span class="hs-identifier hs-var">shannonEntropy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055468"><span class="hs-identifier hs-var">totWeight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679055453"><span class="hs-identifier hs-var">weights</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-comment">-- | Calculate the shannon entropy of a set of tiles. We use type `Weights` instead of a list of tiles</span><span>
</span><span id="line-55"></span><span class="hs-comment">--   to avoid reevaluating the rules of the tiles and recalculating the total weight of these tiles.</span><span>
</span><span id="line-56"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#shannonEntropy"><span class="hs-identifier hs-type">shannonEntropy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-type">ShannonEntropy</span></a></span><span>
</span><span id="line-57"></span><span id="shannonEntropy"><span class="annot"><span class="annottext">shannonEntropy :: Weights -&gt; Float
</span><a href="Gen.WaveFuncCollapse.html#shannonEntropy"><span class="hs-identifier hs-var hs-var">shannonEntropy</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679055471"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055471"><span class="hs-identifier hs-var">totWeight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055472"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679055472"><span class="hs-identifier hs-var">weights</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float
forall a. Floating a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">log</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055471"><span class="hs-identifier hs-var">totWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055474"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055471"><span class="hs-identifier hs-var">totWeight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-59"></span><span>    </span><span id="local-6989586621679055474"><span class="annot"><span class="annottext">h :: Float
</span><a href="#local-6989586621679055474"><span class="hs-identifier hs-var hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Float -&gt; Float -&gt; Float) -&gt; Float -&gt; [Float] -&gt; Float
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679055481"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055481"><span class="hs-identifier hs-var">weight</span></a></span></span><span> </span><span id="local-6989586621679055482"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055482"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055482"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055481"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span>  </span><span class="annot"><span class="annottext">Float -&gt; Float
forall a. Floating a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">log</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055481"><span class="hs-identifier hs-var">weight</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679055472"><span class="hs-identifier hs-var">weights</span></a></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span class="hs-comment">-- | The helper function of the `waveFuncCollape` function. It will iteratively call the `waveFuncCollapseStep`</span><span>
</span><span id="line-62"></span><span class="hs-comment">--   function until there are no more available positions in the environment. This function is called with the </span><span>
</span><span id="line-63"></span><span class="hs-comment">--   position where the wave function should collapse. This position is generated using the `shannonPos` </span><span>
</span><span id="line-64"></span><span class="hs-comment">--   function. If the algorithm gets stuck, it will call the `resetWaveFuncCollapse` function. </span><span>
</span><span id="line-65"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-type">waveFuncCollapse'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span>
</span><span id="line-66"></span><span id="waveFuncCollapse%27"><span class="annot"><span class="annottext">waveFuncCollapse' :: [Tile] -&gt; TileMap -&gt; Env -&gt; IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-var hs-var">waveFuncCollapse'</span></a></span></span><span> </span><span id="local-6989586621679055488"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055488"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span id="local-6989586621679055489"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679055489"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span> </span><span id="local-6989586621679055490"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055490"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Env -&gt; Bool
forall k a. Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">M.null</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055490"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TileMap -&gt; IO TileMap
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679055489"><span class="hs-identifier hs-var">tileMap</span></a></span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-69"></span><span>    </span><span id="local-6989586621679055492"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679055492"><span class="hs-identifier hs-var">randomPos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; IO Pos
</span><a href="Gen.WaveFuncCollapse.html#shannonPos"><span class="hs-identifier hs-var">shannonPos</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055490"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-70"></span><span>    </span><span class="annot"><span class="annottext">[Tile] -&gt; Pos -&gt; TileMap -&gt; Env -&gt; IO (Maybe (TileMap, Env))
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapseStep"><span class="hs-identifier hs-var">waveFuncCollapseStep</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055488"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679055492"><span class="hs-identifier hs-var">randomPos</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679055489"><span class="hs-identifier hs-var">tileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055490"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe (TileMap, Env))
-&gt; (Maybe (TileMap, Env) -&gt; IO TileMap) -&gt; IO TileMap
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-71"></span><span>      </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#resetWaveFuncCollapse"><span class="hs-identifier hs-var">resetWaveFuncCollapse</span></a></span><span>
</span><span id="line-72"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679055493"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679055493"><span class="hs-identifier hs-var">newTileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055494"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055494"><span class="hs-identifier hs-var">newEnv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; TileMap -&gt; Env -&gt; IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-var">waveFuncCollapse'</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055488"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679055493"><span class="hs-identifier hs-var">newTileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055494"><span class="hs-identifier hs-var">newEnv</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-comment">-- | Reset the wave function collapse algorithm. This is done when the algorithm gets stuck and can't continue.</span><span>
</span><span id="line-75"></span><span class="hs-comment">--   Not implemented yet. Optimally the algorithm should be able to backtrack to a previously solvable state.</span><span>
</span><span id="line-76"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#resetWaveFuncCollapse"><span class="hs-identifier hs-type">resetWaveFuncCollapse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span>
</span><span id="line-77"></span><span id="resetWaveFuncCollapse"><span class="annot"><span class="annottext">resetWaveFuncCollapse :: IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#resetWaveFuncCollapse"><span class="hs-identifier hs-var hs-var">resetWaveFuncCollapse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO TileMap
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-comment">-- | Get the position with the lowest shannon entropy. If there are multiple positions with the same entropy,</span><span>
</span><span id="line-80"></span><span class="hs-comment">--   the function will return a random position from the list of positions.</span><span>
</span><span id="line-81"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#shannonPos"><span class="hs-identifier hs-type">shannonPos</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span>
</span><span id="line-82"></span><span id="shannonPos"><span class="annot"><span class="annottext">shannonPos :: Env -&gt; IO Pos
</span><a href="Gen.WaveFuncCollapse.html#shannonPos"><span class="hs-identifier hs-var hs-var">shannonPos</span></a></span></span><span> </span><span id="local-6989586621679055496"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055496"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Pos] -&gt; IO Pos
forall a. [a] -&gt; IO a
</span><a href="Gen.WaveFuncCollapse.html#getRandomElement"><span class="hs-identifier hs-var">getRandomElement</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Float, [Pos]) -&gt; [Pos]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Pos
 -&gt; ([Tile], Weights, Float) -&gt; (Float, [Pos]) -&gt; (Float, [Pos]))
-&gt; (Float, [Pos]) -&gt; Env -&gt; (Float, [Pos])
forall k a b. (k -&gt; a -&gt; b -&gt; b) -&gt; b -&gt; Map k a -&gt; b
</span><span class="hs-identifier hs-var">M.foldrWithKey</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; ([Tile], Weights, Float) -&gt; (Float, [Pos]) -&gt; (Float, [Pos])
forall {a} {a} {a} {b}.
(Num a, Ord a) =&gt;
a -&gt; (a, b, a) -&gt; (a, [a]) -&gt; (a, [a])
</span><a href="#local-6989586621679055500"><span class="hs-identifier hs-var">minList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055496"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-84"></span><span>    </span><span id="local-6989586621679055500"><span class="annot"><span class="annottext">minList :: a -&gt; (a, b, a) -&gt; (a, [a]) -&gt; (a, [a])
</span><a href="#local-6989586621679055500"><span class="hs-identifier hs-var hs-var">minList</span></a></span></span><span> </span><span id="local-6989586621679055510"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679055510"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055511"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679055511"><span class="hs-identifier hs-var">entropy</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679055512"><span class="annot"><span class="annottext">(a, [a])
</span><a href="#local-6989586621679055512"><span class="hs-identifier hs-var">list</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(a, [a])
</span><a href="#local-6989586621679055512"><span class="hs-identifier hs-var">list</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-85"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679055511"><span class="hs-identifier hs-var">entropy</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679055510"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679055513"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679055513"><span class="hs-identifier hs-var">minEntropy</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055514"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679055514"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679055511"><span class="hs-identifier hs-var">entropy</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679055513"><span class="hs-identifier hs-var">minEntropy</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679055511"><span class="hs-identifier hs-var">entropy</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679055510"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679055511"><span class="hs-identifier hs-var">entropy</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679055513"><span class="hs-identifier hs-var">minEntropy</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679055513"><span class="hs-identifier hs-var">minEntropy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679055510"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679055514"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(a, [a])
</span><a href="#local-6989586621679055512"><span class="hs-identifier hs-var">list</span></a></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="annot"><span class="hs-comment">-- | Get a random element from a list</span></span><span>
</span><span id="line-92"></span><span id="local-6989586621679055348"><span class="annot"><a href="Gen.WaveFuncCollapse.html#getRandomElement"><span class="hs-identifier hs-type">getRandomElement</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679055348"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679055348"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-93"></span><span id="getRandomElement"><span class="annot"><span class="annottext">getRandomElement :: forall a. [a] -&gt; IO a
</span><a href="Gen.WaveFuncCollapse.html#getRandomElement"><span class="hs-identifier hs-var hs-var">getRandomElement</span></a></span></span><span> </span><span id="local-6989586621679055528"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679055528"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-94"></span><span>    </span><span id="local-6989586621679055529"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055529"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; IO Int
forall a (m :: * -&gt; *). (Random a, MonadIO m) =&gt; (a, a) -&gt; m a
</span><span class="hs-identifier hs-var">randomRIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679055528"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>    </span><span class="annot"><span class="annottext">a -&gt; IO a
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679055528"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int -&gt; a
forall a. HasCallStack =&gt; [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055529"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-comment">-- | Collapse the wave function of a single position. Selects a random tile from the environment and</span><span>
</span><span id="line-98"></span><span class="hs-comment">--  adds it to the tileMap. If the environment has no possible tiles, the function will return Nothing.</span><span>
</span><span id="line-99"></span><span class="hs-comment">--  After the tile has been added to the tileMap, the position will be removed from the environment,</span><span>
</span><span id="line-100"></span><span class="hs-comment">--  and the environment will be updated with the new possible tiles.</span><span>
</span><span id="line-101"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#waveFuncCollapseStep"><span class="hs-identifier hs-type">waveFuncCollapseStep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span id="waveFuncCollapseStep"><span class="annot"><span class="annottext">waveFuncCollapseStep :: [Tile] -&gt; Pos -&gt; TileMap -&gt; Env -&gt; IO (Maybe (TileMap, Env))
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapseStep"><span class="hs-identifier hs-var hs-var">waveFuncCollapseStep</span></a></span></span><span> </span><span id="local-6989586621679055533"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055533"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span id="local-6989586621679055534"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679055534"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span id="local-6989586621679055535"><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679055535"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679055536"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055536"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679055541"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055541"><span class="hs-identifier hs-var">tiles</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055542"><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679055542"><span class="hs-identifier hs-var">weight</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055536"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Pos -&gt; ([Tile], Weights, Float)
forall k a. Ord k =&gt; Map k a -&gt; k -&gt; a
</span><span class="hs-operator hs-var">M.!</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679055534"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-104"></span><span>  </span><span id="local-6989586621679055544"><span class="annot"><span class="annottext">Maybe Tile
</span><a href="#local-6989586621679055544"><span class="hs-identifier hs-var">tile</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; Weights -&gt; IO (Maybe Tile)
</span><a href="Gen.WaveFuncCollapse.html#randomTile"><span class="hs-identifier hs-var">randomTile</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055541"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679055542"><span class="hs-identifier hs-var">weight</span></a></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Tile
</span><a href="#local-6989586621679055544"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><span class="annottext">Maybe Tile
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env) -&gt; IO (Maybe (TileMap, Env))
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-107"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679055546"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679055546"><span class="hs-identifier hs-var">tile</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679055551"><span class="annot"><span class="annottext">newTileMap :: Map Pos Tile
</span><a href="#local-6989586621679055551"><span class="hs-identifier hs-var hs-var">newTileMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Tile -&gt; Map Pos Tile -&gt; Map Pos Tile
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679055534"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679055546"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679055535"><span class="hs-identifier hs-var">tileMap</span></a></span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679055556"><span class="annot"><span class="annottext">newEnv :: Env
</span><a href="#local-6989586621679055556"><span class="hs-identifier hs-var hs-var">newEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Env -&gt; Env
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.delete</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679055534"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055536"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-110"></span><span>      </span><span class="annot"><span class="annottext">Maybe (TileMap, Env) -&gt; IO (Maybe (TileMap, Env))
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (TileMap, Env) -&gt; IO (Maybe (TileMap, Env)))
-&gt; Maybe (TileMap, Env) -&gt; IO (Maybe (TileMap, Env))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; TileMap -&gt; [Pos] -&gt; Maybe (TileMap, Env)
</span><a href="Gen.WaveFuncCollapse.html#createEnv"><span class="hs-identifier hs-var">createEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055541"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile -&gt; TileMap
</span><a href="Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679055551"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env -&gt; [Pos]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679055556"><span class="hs-identifier hs-var">newEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-comment">-- | Select a random tile from a list of tiles based on their weights.</span><span>
</span><span id="line-113"></span><span class="hs-comment">--   If the total weight is 0, the function will return Nothing.</span><span>
</span><span id="line-114"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#randomTile"><span class="hs-identifier hs-type">randomTile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span id="randomTile"><span class="annot"><span class="annottext">randomTile :: [Tile] -&gt; Weights -&gt; IO (Maybe Tile)
</span><a href="Gen.WaveFuncCollapse.html#randomTile"><span class="hs-identifier hs-var hs-var">randomTile</span></a></span></span><span> </span><span id="local-6989586621679055559"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055559"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679055560"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055560"><span class="hs-identifier hs-var">totalWeight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679055561"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679055561"><span class="hs-identifier hs-var">tilesWeight</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055560"><span class="hs-identifier hs-var">totalWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0.0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe Tile -&gt; IO (Maybe Tile)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Tile
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>        </span><span id="local-6989586621679055562"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055562"><span class="hs-identifier hs-var">randomNum</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Float, Float) -&gt; IO Float
forall a (m :: * -&gt; *). (Random a, MonadIO m) =&gt; (a, a) -&gt; m a
</span><span class="hs-identifier hs-var">randomRIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0.0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055560"><span class="hs-identifier hs-var">totalWeight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>        </span><span class="annot"><span class="annottext">Maybe Tile -&gt; IO (Maybe Tile)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Tile -&gt; IO (Maybe Tile)) -&gt; Maybe Tile -&gt; IO (Maybe Tile)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; [Float] -&gt; Float -&gt; Maybe Tile
</span><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var">weightToTile</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055559"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679055561"><span class="hs-identifier hs-var">tilesWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055562"><span class="hs-identifier hs-var">randomNum</span></a></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="hs-comment">-- | Convert a list of tiles and their weights to a single tile based on a random number.</span><span>
</span><span id="line-120"></span><span class="hs-comment">--  The function will return Nothing if list of tiles and weights are empty or the random number is </span><span>
</span><span id="line-121"></span><span class="hs-comment">--  greater than the total weight. The length of the tiles and weights must be the same.</span><span>
</span><span id="line-122"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-type">weightToTile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span>
</span><span id="line-123"></span><span id="weightToTile"><span class="annot"><span class="annottext">weightToTile :: [Tile] -&gt; [Float] -&gt; Float -&gt; Maybe Tile
</span><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var hs-var">weightToTile</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Tile
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-124"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var">weightToTile</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679055564"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679055564"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679055565"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055565"><span class="hs-identifier hs-var">tiles</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679055566"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055566"><span class="hs-identifier hs-var">weight</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679055567"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679055567"><span class="hs-identifier hs-var">weights</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679055568"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055568"><span class="hs-identifier hs-var">random</span></a></span></span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055568"><span class="hs-identifier hs-var">random</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055566"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tile -&gt; Maybe Tile
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679055564"><span class="hs-identifier hs-var">tile</span></a></span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; [Float] -&gt; Float -&gt; Maybe Tile
</span><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var">weightToTile</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055565"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679055567"><span class="hs-identifier hs-var">weights</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055568"><span class="hs-identifier hs-var">random</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679055566"><span class="hs-identifier hs-var">weight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var">weightToTile</span></a></span><span> </span><span id="local-6989586621679055569"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679055569"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span id="local-6989586621679055570"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679055570"><span class="hs-identifier hs-var">weights</span></a></span></span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Maybe Tile
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;WeightToTile: tiles and weights are not the same length&quot;</span></span><span>
</span><span id="line-128"></span></pre></body></html>