<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | The wave function collapse algorithm is a way to generate a tilemap based on a set of rules.</span><span>
</span><span id="line-2"></span><span class="hs-comment">--   The algorithm works by starting with a completely empty tilemap and then collapsing the wave function</span><span>
</span><span id="line-3"></span><span class="hs-comment">--   of each tile based on the rules and the surrounding tiles. This is done until the entire tilemap is filled.</span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Gen.WaveFuncCollapse</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Def.html"><span class="hs-identifier">Def</span></a></span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Debug.Trace</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">trace</span></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">delete</span></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="annot"><span class="hs-comment">-- | Weights is a tuple of a float and a list of floats (Total weight, [Weights])</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">type</span><span> </span><span id="Weights"><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-var">Weights</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">type</span><span> </span><span id="ShannonEntropy"><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-var">ShannonEntropy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">type</span><span> </span><span id="Env"><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-var">Env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-type">ShannonEntropy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">type</span><span> </span><span id="History"><span class="annot"><a href="Gen.WaveFuncCollapse.html#History"><span class="hs-identifier hs-var">History</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Gen.WaveFuncCollapse.html#HistoryUnit"><span class="hs-identifier hs-type">HistoryUnit</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-19"></span><span class="hs-keyword">data</span><span> </span><span id="HistoryUnit"><span class="annot"><a href="Gen.WaveFuncCollapse.html#HistoryUnit"><span class="hs-identifier hs-var">HistoryUnit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="HistoryUnit"><span class="annot"><a href="Gen.WaveFuncCollapse.html#HistoryUnit"><span class="hs-identifier hs-var">HistoryUnit</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-20"></span><span>  </span><span id="tileMap"><span class="annot"><span class="annottext">HistoryUnit -&gt; TileMap
</span><a href="Gen.WaveFuncCollapse.html#tileMap"><span class="hs-identifier hs-var hs-var">tileMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>  </span><span id="env"><span class="annot"><span class="annottext">HistoryUnit -&gt; Env
</span><a href="Gen.WaveFuncCollapse.html#env"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>  </span><span id="pos"><span class="annot"><span class="annottext">HistoryUnit -&gt; Pos
</span><a href="Gen.WaveFuncCollapse.html#pos"><span class="hs-identifier hs-var hs-var">pos</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>  </span><span id="tile"><span class="annot"><span class="annottext">HistoryUnit -&gt; Tile
</span><a href="Gen.WaveFuncCollapse.html#tile"><span class="hs-identifier hs-var hs-var">tile</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span>
</span><span id="line-24"></span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056440"><span id="local-6989586621679056452"><span id="local-6989586621679056456"><span class="annot"><span class="annottext">Int -&gt; HistoryUnit -&gt; ShowS
[HistoryUnit] -&gt; ShowS
HistoryUnit -&gt; String
(Int -&gt; HistoryUnit -&gt; ShowS)
-&gt; (HistoryUnit -&gt; String)
-&gt; ([HistoryUnit] -&gt; ShowS)
-&gt; Show HistoryUnit
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; HistoryUnit -&gt; ShowS
showsPrec :: Int -&gt; HistoryUnit -&gt; ShowS
$cshow :: HistoryUnit -&gt; String
show :: HistoryUnit -&gt; String
$cshowList :: [HistoryUnit] -&gt; ShowS
showList :: [HistoryUnit] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-comment">-- Backtracking: </span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-comment">-- | Initialize the wave function collapse algorithm with a list of tiles and a size for the world.</span><span>
</span><span id="line-30"></span><span class="hs-comment">--   The algorithm will then generate a tilemap and an environment using the `createEnv` function.</span><span>
</span><span id="line-31"></span><span class="hs-comment">--   If no Environment can be created with the current Tile set, the function throw an error.</span><span>
</span><span id="line-32"></span><span class="hs-comment">--   Afterwards it will invoke `waveFuncCollapse'` which will iteratiively collapse the wave function. </span><span>
</span><span id="line-33"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse"><span class="hs-identifier hs-type">waveFuncCollapse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Def.html#Size"><span class="hs-identifier hs-type">Size</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span>
</span><span id="line-34"></span><span id="waveFuncCollapse"><span class="annot"><span class="annottext">waveFuncCollapse :: [Tile] -&gt; Size -&gt; IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse"><span class="hs-identifier hs-var hs-var">waveFuncCollapse</span></a></span></span><span> </span><span id="local-6989586621679056476"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056476"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span id="local-6989586621679056477"><span class="annot"><span class="annottext">size :: Size
</span><a href="#local-6989586621679056477"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679056478"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056478"><span class="hs-identifier hs-var">minX</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056479"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056479"><span class="hs-identifier hs-var">minY</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056480"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056480"><span class="hs-identifier hs-var">minZ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056481"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056481"><span class="hs-identifier hs-var">maxX</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056482"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056482"><span class="hs-identifier hs-var">maxY</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056483"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056483"><span class="hs-identifier hs-var">maxZ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679056488"><span class="annot"><span class="annottext">allPos :: [Pos]
</span><a href="#local-6989586621679056488"><span class="hs-identifier hs-var hs-var">allPos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056489"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056490"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056491"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679056489"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056489"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056478"><span class="hs-identifier hs-var">minX</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056481"><span class="hs-identifier hs-var">maxX</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056490"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056490"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056479"><span class="hs-identifier hs-var">minY</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056482"><span class="hs-identifier hs-var">maxY</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056491"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056491"><span class="hs-identifier hs-var">z</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056480"><span class="hs-identifier hs-var">minZ</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056483"><span class="hs-identifier hs-var">maxZ</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679056492"><span class="annot"><span class="annottext">emptyTileMap :: TileMap
</span><a href="#local-6989586621679056492"><span class="hs-identifier hs-var hs-var">emptyTileMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Pos Tile -&gt; TileMap
</span><a href="Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; TileMap -&gt; [Pos] -&gt; Maybe (TileMap, Env)
</span><a href="Gen.WaveFuncCollapse.html#createEnv"><span class="hs-identifier hs-var">createEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056476"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056492"><span class="hs-identifier hs-var">emptyTileMap</span></a></span><span> </span><span class="annot"><span class="annottext">[Pos]
</span><a href="#local-6989586621679056488"><span class="hs-identifier hs-var">allPos</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO TileMap
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;No possible tilemap&quot;</span></span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056496"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056496"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056497"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056497"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TileMap -&gt; Env -&gt; [HistoryUnit] -&gt; IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-var">waveFuncCollapse'</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056496"><span class="hs-identifier hs-var">tileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056497"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-comment">-- | Create the tileMap and environment for the wave function collapse algorithm</span><span>
</span><span id="line-42"></span><span class="hs-comment">--   It applies the rule to each position and creates the environment based on the result.</span><span>
</span><span id="line-43"></span><span class="hs-comment">--   If an environment only has one possible tile it will be added to the tileMap, </span><span>
</span><span id="line-44"></span><span class="hs-comment">--   and removed from the environment. If an environment has no possible tiles, the function will return Nothing.</span><span>
</span><span id="line-45"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#createEnv"><span class="hs-identifier hs-type">createEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span id="createEnv"><span class="annot"><span class="annottext">createEnv :: [Tile] -&gt; TileMap -&gt; [Pos] -&gt; Maybe (TileMap, Env)
</span><a href="Gen.WaveFuncCollapse.html#createEnv"><span class="hs-identifier hs-var hs-var">createEnv</span></a></span></span><span> </span><span id="local-6989586621679056498"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056498"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span id="local-6989586621679056499"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056499"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Pos -&gt; Maybe (TileMap, Env) -&gt; Maybe (TileMap, Env))
-&gt; Maybe (TileMap, Env) -&gt; [Pos] -&gt; Maybe (TileMap, Env)
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679056501"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056501"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621679056502"><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><a href="#local-6989586621679056502"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><a href="#local-6989586621679056502"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><span id="line-47"></span><span>  </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span id="local-6989586621679056503"><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679056503"><span class="hs-identifier hs-var">newTileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056504"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056504"><span class="hs-identifier hs-var">newEnv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Pos
-&gt; [Tile]
-&gt; TileMap
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
</span><a href="Gen.WaveFuncCollapse.html#posToEnv"><span class="hs-identifier hs-var">posToEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056501"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056498"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile -&gt; TileMap
</span><a href="Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679056503"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Either Tile ([Tile], Weights, Float))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679056506"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056506"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TileMap, Env) -&gt; Maybe (TileMap, Env)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile -&gt; TileMap
</span><a href="Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Pos Tile -&gt; TileMap) -&gt; Map Pos Tile -&gt; TileMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Tile -&gt; Map Pos Tile -&gt; Map Pos Tile
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056501"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056506"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679056503"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056504"><span class="hs-identifier hs-var">newEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679056508"><span class="annot"><span class="annottext">([Tile], Weights, Float)
</span><a href="#local-6989586621679056508"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TileMap, Env) -&gt; Maybe (TileMap, Env)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile -&gt; TileMap
</span><a href="Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679056503"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; ([Tile], Weights, Float) -&gt; Env -&gt; Env
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056501"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">([Tile], Weights, Float)
</span><a href="#local-6989586621679056508"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056504"><span class="hs-identifier hs-var">newEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TileMap, Env) -&gt; Maybe (TileMap, Env)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056499"><span class="hs-identifier hs-var">tileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#updateEnv"><span class="hs-identifier hs-type">updateEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span id="updateEnv"><span class="annot"><span class="annottext">updateEnv :: TileMap -&gt; Env -&gt; Maybe (TileMap, Env)
</span><a href="Gen.WaveFuncCollapse.html#updateEnv"><span class="hs-identifier hs-var hs-var">updateEnv</span></a></span></span><span> </span><span id="local-6989586621679056510"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056510"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span> </span><span id="local-6989586621679056511"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056511"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Pos -&gt; Maybe (TileMap, Env) -&gt; Maybe (TileMap, Env))
-&gt; Maybe (TileMap, Env) -&gt; [Pos] -&gt; Maybe (TileMap, Env)
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679056512"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056512"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621679056513"><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><a href="#local-6989586621679056513"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><a href="#local-6989586621679056513"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><span id="line-56"></span><span>  </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-57"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span id="local-6989586621679056514"><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679056514"><span class="hs-identifier hs-var">newTileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056515"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056515"><span class="hs-identifier hs-var">newEnv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056520"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056520"><span class="hs-identifier hs-var">tiles</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056511"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Pos -&gt; ([Tile], Weights, Float)
forall k a. Ord k =&gt; Map k a -&gt; k -&gt; a
</span><span class="hs-operator hs-var">M.!</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056512"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Pos
-&gt; [Tile]
-&gt; TileMap
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
</span><a href="Gen.WaveFuncCollapse.html#posToEnv"><span class="hs-identifier hs-var">posToEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056512"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056520"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile -&gt; TileMap
</span><a href="Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679056514"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-59"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Either Tile ([Tile], Weights, Float))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-60"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679056522"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056522"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TileMap, Env) -&gt; Maybe (TileMap, Env)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile -&gt; TileMap
</span><a href="Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Pos Tile -&gt; TileMap) -&gt; Map Pos Tile -&gt; TileMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Tile -&gt; Map Pos Tile -&gt; Map Pos Tile
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056512"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056522"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679056514"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056515"><span class="hs-identifier hs-var">newEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679056523"><span class="annot"><span class="annottext">([Tile], Weights, Float)
</span><a href="#local-6989586621679056523"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TileMap, Env) -&gt; Maybe (TileMap, Env)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile -&gt; TileMap
</span><a href="Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679056514"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; ([Tile], Weights, Float) -&gt; Env -&gt; Env
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056512"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">([Tile], Weights, Float)
</span><a href="#local-6989586621679056523"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056515"><span class="hs-identifier hs-var">newEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TileMap, Env) -&gt; Maybe (TileMap, Env)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056510"><span class="hs-identifier hs-var">tileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env -&gt; [Pos]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056511"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#posToEnv"><span class="hs-identifier hs-type">posToEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-type">ShannonEntropy</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-65"></span><span id="posToEnv"><span class="annot"><span class="annottext">posToEnv :: Pos
-&gt; [Tile]
-&gt; TileMap
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
</span><a href="Gen.WaveFuncCollapse.html#posToEnv"><span class="hs-identifier hs-var hs-var">posToEnv</span></a></span></span><span> </span><span id="local-6989586621679056525"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056525"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621679056526"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056526"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span id="local-6989586621679056527"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056527"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679056528"><span class="annot"><span class="annottext">weights :: [Float]
</span><a href="#local-6989586621679056528"><span class="hs-identifier hs-var hs-var">weights</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Tile -&gt; Float) -&gt; [Tile] -&gt; [Float]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleResult -&gt; Float
</span><a href="Def.html#resultToFloat"><span class="hs-identifier hs-var">resultToFloat</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleResult -&gt; Float) -&gt; (Tile -&gt; RuleResult) -&gt; Tile -&gt; Float
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Def.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span id="local-6989586621679056532"><span class="annot"><span class="annottext">TileMap -&gt; Pos -&gt; RuleResult
</span><a href="#local-6989586621679056532"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TileMap -&gt; Pos -&gt; RuleResult
</span><a href="#local-6989586621679056532"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056527"><span class="hs-identifier hs-var">tileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056525"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Rule -&gt; RuleResult) -&gt; (Tile -&gt; Rule) -&gt; Tile -&gt; RuleResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Tile -&gt; Rule
</span><a href="Def.html#rules"><span class="hs-identifier hs-var">rules</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056526"><span class="hs-identifier hs-var">tiles</span></a></span><span>
</span><span id="line-67"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679056536"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056536"><span class="hs-identifier hs-var">newTiles</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056537"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056537"><span class="hs-identifier hs-var">newWeights</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Tile, Float)] -&gt; ([Tile], [Float])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Tile, Float)] -&gt; ([Tile], [Float]))
-&gt; [(Tile, Float)] -&gt; ([Tile], [Float])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Tile, Float) -&gt; Bool) -&gt; [(Tile, Float)] -&gt; [(Tile, Float)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tile
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056539"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056539"><span class="hs-identifier hs-var">weight</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056539"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Tile, Float)] -&gt; [(Tile, Float)])
-&gt; [(Tile, Float)] -&gt; [(Tile, Float)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; [Float] -&gt; [(Tile, Float)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056526"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056528"><span class="hs-identifier hs-var">weights</span></a></span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056536"><span class="hs-identifier hs-var">newTiles</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Either Tile ([Tile], Weights, Float))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">[</span><span id="local-6989586621679056541"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056541"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Tile ([Tile], Weights, Float)
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Either Tile ([Tile], Weights, Float)
 -&gt; Maybe (Either Tile ([Tile], Weights, Float)))
-&gt; Either Tile ([Tile], Weights, Float)
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tile -&gt; Either Tile ([Tile], Weights, Float)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056541"><span class="hs-identifier hs-var">tile</span></a></span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><span class="annottext">[Tile]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>      </span><span>
</span><span id="line-72"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679056544"><span class="annot"><span class="annottext">totWeight :: Float
</span><a href="#local-6989586621679056544"><span class="hs-identifier hs-var hs-var">totWeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Float] -&gt; Float
forall a. Num a =&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056537"><span class="hs-identifier hs-var">newWeights</span></a></span><span>
</span><span id="line-73"></span><span>      </span><span class="annot"><span class="annottext">Either Tile ([Tile], Weights, Float)
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Either Tile ([Tile], Weights, Float)
 -&gt; Maybe (Either Tile ([Tile], Weights, Float)))
-&gt; Either Tile ([Tile], Weights, Float)
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([Tile], Weights, Float) -&gt; Either Tile ([Tile], Weights, Float)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056536"><span class="hs-identifier hs-var">newTiles</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056544"><span class="hs-identifier hs-var">totWeight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056537"><span class="hs-identifier hs-var">newWeights</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights -&gt; Float
</span><a href="Gen.WaveFuncCollapse.html#shannonEntropy"><span class="hs-identifier hs-var">shannonEntropy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056544"><span class="hs-identifier hs-var">totWeight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056537"><span class="hs-identifier hs-var">newWeights</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-comment">-- | Calculate the shannon entropy of a set of tiles. We use type `Weights` instead of a list of tiles</span><span>
</span><span id="line-76"></span><span class="hs-comment">--   to avoid reevaluating the rules of the tiles and recalculating the total weight of these tiles.</span><span>
</span><span id="line-77"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#shannonEntropy"><span class="hs-identifier hs-type">shannonEntropy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-type">ShannonEntropy</span></a></span><span>
</span><span id="line-78"></span><span id="shannonEntropy"><span class="annot"><span class="annottext">shannonEntropy :: Weights -&gt; Float
</span><a href="Gen.WaveFuncCollapse.html#shannonEntropy"><span class="hs-identifier hs-var hs-var">shannonEntropy</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056547"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056547"><span class="hs-identifier hs-var">totWeight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056548"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056548"><span class="hs-identifier hs-var">weights</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float
forall a. Floating a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">log</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056547"><span class="hs-identifier hs-var">totWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056550"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056547"><span class="hs-identifier hs-var">totWeight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-80"></span><span>    </span><span id="local-6989586621679056550"><span class="annot"><span class="annottext">h :: Float
</span><a href="#local-6989586621679056550"><span class="hs-identifier hs-var hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Float -&gt; Float -&gt; Float) -&gt; Float -&gt; [Float] -&gt; Float
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679056557"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056557"><span class="hs-identifier hs-var">weight</span></a></span></span><span> </span><span id="local-6989586621679056558"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056558"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056558"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056557"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span>  </span><span class="annot"><span class="annottext">Float -&gt; Float
forall a. Floating a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">log</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056557"><span class="hs-identifier hs-var">weight</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056548"><span class="hs-identifier hs-var">weights</span></a></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">-- | The helper function of the `waveFuncCollape` function. It will iteratively call the `waveFuncCollapseStep`</span><span>
</span><span id="line-83"></span><span class="hs-comment">--   function until there are no more available positions in the environment. This function is called with the </span><span>
</span><span id="line-84"></span><span class="hs-comment">--   position where the wave function should collapse. This position is generated using the `shannonPos` </span><span>
</span><span id="line-85"></span><span class="hs-comment">--   function. If the algorithm gets stuck, it will call the `resetWaveFuncCollapse` function. </span><span>
</span><span id="line-86"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-type">waveFuncCollapse'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#History"><span class="hs-identifier hs-type">History</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span>
</span><span id="line-87"></span><span id="waveFuncCollapse%27"><span class="annot"><span class="annottext">waveFuncCollapse' :: TileMap -&gt; Env -&gt; [HistoryUnit] -&gt; IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-var hs-var">waveFuncCollapse'</span></a></span></span><span> </span><span id="local-6989586621679056564"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056564"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span> </span><span id="local-6989586621679056565"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056565"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621679056566"><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679056566"><span class="hs-identifier hs-var">history</span></a></span></span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Env -&gt; Bool
forall k a. Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">M.null</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056565"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TileMap -&gt; IO TileMap
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056564"><span class="hs-identifier hs-var">tileMap</span></a></span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-90"></span><span>    </span><span id="local-6989586621679056568"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056568"><span class="hs-identifier hs-var">randomPos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; IO Pos
</span><a href="Gen.WaveFuncCollapse.html#shannonPos"><span class="hs-identifier hs-var">shannonPos</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056565"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679056569"><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><a href="#local-6989586621679056569"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056570"><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679056570"><span class="hs-identifier hs-var">newHistory</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pos
-&gt; TileMap
-&gt; Env
-&gt; [HistoryUnit]
-&gt; IO (Maybe (TileMap, Env), [HistoryUnit])
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapseStep"><span class="hs-identifier hs-var">waveFuncCollapseStep</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056568"><span class="hs-identifier hs-var">randomPos</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056564"><span class="hs-identifier hs-var">tileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056565"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679056566"><span class="hs-identifier hs-var">history</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><a href="#local-6989586621679056569"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-93"></span><span>      </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[HistoryUnit] -&gt; IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#resetWaveFuncCollapse"><span class="hs-identifier hs-var">resetWaveFuncCollapse</span></a></span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679056570"><span class="hs-identifier hs-var">newHistory</span></a></span><span>
</span><span id="line-94"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056571"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056571"><span class="hs-identifier hs-var">newTileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056572"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056572"><span class="hs-identifier hs-var">newEnv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TileMap -&gt; Env -&gt; [HistoryUnit] -&gt; IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-var">waveFuncCollapse'</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056571"><span class="hs-identifier hs-var">newTileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056572"><span class="hs-identifier hs-var">newEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679056570"><span class="hs-identifier hs-var">newHistory</span></a></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">-- | Reset the wave function collapse algorithm. This is done when the algorithm gets stuck and can't continue.</span><span>
</span><span id="line-97"></span><span class="hs-comment">--   Not implemented yet. Optimally the algorithm should be able to backtrack to a previously solvable state.</span><span>
</span><span id="line-98"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#resetWaveFuncCollapse"><span class="hs-identifier hs-type">resetWaveFuncCollapse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#History"><span class="hs-identifier hs-type">History</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span>
</span><span id="line-99"></span><span id="resetWaveFuncCollapse"><span class="annot"><span class="annottext">resetWaveFuncCollapse :: [HistoryUnit] -&gt; IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#resetWaveFuncCollapse"><span class="hs-identifier hs-var hs-var">resetWaveFuncCollapse</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO TileMap
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;No possible tilemaps with the current rules&quot;</span></span><span>
</span><span id="line-100"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#resetWaveFuncCollapse"><span class="hs-identifier hs-var">resetWaveFuncCollapse</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Gen.WaveFuncCollapse.html#HistoryUnit"><span class="hs-identifier hs-type">HistoryUnit</span></a></span><span> </span><span id="local-6989586621679056573"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056573"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span> </span><span id="local-6989586621679056574"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056574"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621679056575"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056575"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621679056576"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056576"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679056577"><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679056577"><span class="hs-identifier hs-var">history</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679056582"><span class="annot"><span class="annottext">newEnv :: Env
</span><a href="#local-6989586621679056582"><span class="hs-identifier hs-var hs-var">newEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(([Tile], Weights, Float) -&gt; ([Tile], Weights, Float))
-&gt; Pos -&gt; Env -&gt; Env
forall k a. Ord k =&gt; (a -&gt; a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.adjust</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679056584"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056584"><span class="hs-identifier hs-var">tiles</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056585"><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679056585"><span class="hs-identifier hs-var">weights</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056586"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056586"><span class="hs-identifier hs-var">newTiles</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056587"><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679056587"><span class="hs-identifier hs-var">newWeights</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tile -&gt; ([Tile], Weights) -&gt; ([Tile], Weights)
</span><a href="#local-6989586621679056588"><span class="hs-identifier hs-var">deleteTile</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056576"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056584"><span class="hs-identifier hs-var">tiles</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679056585"><span class="hs-identifier hs-var">weights</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056586"><span class="hs-identifier hs-var">newTiles</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679056587"><span class="hs-identifier hs-var">newWeights</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights -&gt; Float
</span><a href="Gen.WaveFuncCollapse.html#shannonEntropy"><span class="hs-identifier hs-var">shannonEntropy</span></a></span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679056587"><span class="hs-identifier hs-var">newWeights</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056575"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056574"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056593"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056593"><span class="hs-identifier hs-var">newTiles</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056582"><span class="hs-identifier hs-var">newEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Pos -&gt; ([Tile], Weights, Float)
forall k a. Ord k =&gt; Map k a -&gt; k -&gt; a
</span><span class="hs-operator hs-var">M.!</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056575"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056593"><span class="hs-identifier hs-var">newTiles</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[HistoryUnit] -&gt; IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#resetWaveFuncCollapse"><span class="hs-identifier hs-var">resetWaveFuncCollapse</span></a></span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679056577"><span class="hs-identifier hs-var">history</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TileMap -&gt; Env -&gt; [HistoryUnit] -&gt; IO TileMap
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-var">waveFuncCollapse'</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056573"><span class="hs-identifier hs-var">tileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056582"><span class="hs-identifier hs-var">newEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679056577"><span class="hs-identifier hs-var">history</span></a></span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><a href="#local-6989586621679056588"><span class="hs-identifier hs-type">deleteTile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>    </span><span id="local-6989586621679056588"><span class="annot"><span class="annottext">deleteTile :: Tile -&gt; ([Tile], Weights) -&gt; ([Tile], Weights)
</span><a href="#local-6989586621679056588"><span class="hs-identifier hs-var hs-var">deleteTile</span></a></span></span><span> </span><span id="local-6989586621679056595"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056595"><span class="hs-identifier hs-var">tile</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056596"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056596"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679056597"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056597"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056598"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056598"><span class="hs-identifier hs-var">totalWeight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056599"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056599"><span class="hs-identifier hs-var">y</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679056600"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056600"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-107"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056596"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Tile -&gt; Tile -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056595"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056597"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056598"><span class="hs-identifier hs-var">totalWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056599"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056600"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679056601"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056601"><span class="hs-identifier hs-var">newTiles'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056602"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056602"><span class="hs-identifier hs-var">totalWeight'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056603"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056603"><span class="hs-identifier hs-var">weights</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056596"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">Tile -&gt; [Tile] -&gt; [Tile]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056601"><span class="hs-identifier hs-var">newTiles'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056602"><span class="hs-identifier hs-var">totalWeight'</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056599"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056599"><span class="hs-identifier hs-var">y</span></a></span><span class="annot"><span class="annottext">Float -&gt; [Float] -&gt; [Float]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056603"><span class="hs-identifier hs-var">weights</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([Tile], Weights) -&gt; ([Tile], Weights))
-&gt; ([Tile], Weights) -&gt; ([Tile], Weights)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tile -&gt; ([Tile], Weights) -&gt; ([Tile], Weights)
</span><a href="#local-6989586621679056588"><span class="hs-identifier hs-var">deleteTile</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056595"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056597"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056598"><span class="hs-identifier hs-var">totalWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056599"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056600"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-comment">-- | Get the position with the lowest shannon entropy. If there are multiple positions with the same entropy,</span><span>
</span><span id="line-112"></span><span class="hs-comment">--   the function will return a random position from the list of positions.</span><span>
</span><span id="line-113"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#shannonPos"><span class="hs-identifier hs-type">shannonPos</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span>
</span><span id="line-114"></span><span id="shannonPos"><span class="annot"><span class="annottext">shannonPos :: Env -&gt; IO Pos
</span><a href="Gen.WaveFuncCollapse.html#shannonPos"><span class="hs-identifier hs-var hs-var">shannonPos</span></a></span></span><span> </span><span id="local-6989586621679056604"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056604"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Pos] -&gt; IO Pos
forall a. [a] -&gt; IO a
</span><a href="Gen.WaveFuncCollapse.html#getRandomElement"><span class="hs-identifier hs-var">getRandomElement</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Float, [Pos]) -&gt; [Pos]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Pos
 -&gt; ([Tile], Weights, Float) -&gt; (Float, [Pos]) -&gt; (Float, [Pos]))
-&gt; (Float, [Pos]) -&gt; Env -&gt; (Float, [Pos])
forall k a b. (k -&gt; a -&gt; b -&gt; b) -&gt; b -&gt; Map k a -&gt; b
</span><span class="hs-identifier hs-var">M.foldrWithKey</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; ([Tile], Weights, Float) -&gt; (Float, [Pos]) -&gt; (Float, [Pos])
forall {a} {a} {a} {b}.
(Num a, Ord a) =&gt;
a -&gt; (a, b, a) -&gt; (a, [a]) -&gt; (a, [a])
</span><a href="#local-6989586621679056608"><span class="hs-identifier hs-var">minList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056604"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-116"></span><span>    </span><span id="local-6989586621679056608"><span class="annot"><span class="annottext">minList :: a -&gt; (a, b, a) -&gt; (a, [a]) -&gt; (a, [a])
</span><a href="#local-6989586621679056608"><span class="hs-identifier hs-var hs-var">minList</span></a></span></span><span> </span><span id="local-6989586621679056618"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679056618"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056619"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679056619"><span class="hs-identifier hs-var">entropy</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679056620"><span class="annot"><span class="annottext">(a, [a])
</span><a href="#local-6989586621679056620"><span class="hs-identifier hs-var">list</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(a, [a])
</span><a href="#local-6989586621679056620"><span class="hs-identifier hs-var">list</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-117"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679056619"><span class="hs-identifier hs-var">entropy</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679056618"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679056621"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679056621"><span class="hs-identifier hs-var">minEntropy</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056622"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679056622"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679056619"><span class="hs-identifier hs-var">entropy</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679056621"><span class="hs-identifier hs-var">minEntropy</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679056619"><span class="hs-identifier hs-var">entropy</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679056618"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679056619"><span class="hs-identifier hs-var">entropy</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679056621"><span class="hs-identifier hs-var">minEntropy</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679056621"><span class="hs-identifier hs-var">minEntropy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679056618"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679056622"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(a, [a])
</span><a href="#local-6989586621679056620"><span class="hs-identifier hs-var">list</span></a></span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="annot"><span class="hs-comment">-- | Get a random element from a list</span></span><span>
</span><span id="line-124"></span><span id="local-6989586621679056356"><span class="annot"><a href="Gen.WaveFuncCollapse.html#getRandomElement"><span class="hs-identifier hs-type">getRandomElement</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679056356"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679056356"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-125"></span><span id="getRandomElement"><span class="annot"><span class="annottext">getRandomElement :: forall a. [a] -&gt; IO a
</span><a href="Gen.WaveFuncCollapse.html#getRandomElement"><span class="hs-identifier hs-var hs-var">getRandomElement</span></a></span></span><span> </span><span id="local-6989586621679056636"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679056636"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-126"></span><span>    </span><span id="local-6989586621679056637"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056637"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; IO Int
forall a (m :: * -&gt; *). (Random a, MonadIO m) =&gt; (a, a) -&gt; m a
</span><span class="hs-identifier hs-var">randomRIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679056636"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><span class="annottext">a -&gt; IO a
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679056636"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int -&gt; a
forall a. HasCallStack =&gt; [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679056637"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-comment">-- | Collapse the wave function of a single position. Selects a random tile from the environment and</span><span>
</span><span id="line-130"></span><span class="hs-comment">--  adds it to the tileMap. If the environment has no possible tiles, the function will return Nothing.</span><span>
</span><span id="line-131"></span><span class="hs-comment">--  After the tile has been added to the tileMap, the position will be removed from the environment,</span><span>
</span><span id="line-132"></span><span class="hs-comment">--  and the environment will be updated with the new possible tiles.</span><span>
</span><span id="line-133"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#waveFuncCollapseStep"><span class="hs-identifier hs-type">waveFuncCollapseStep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#History"><span class="hs-identifier hs-type">History</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#History"><span class="hs-identifier hs-type">History</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span id="waveFuncCollapseStep"><span class="annot"><span class="annottext">waveFuncCollapseStep :: Pos
-&gt; TileMap
-&gt; Env
-&gt; [HistoryUnit]
-&gt; IO (Maybe (TileMap, Env), [HistoryUnit])
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapseStep"><span class="hs-identifier hs-var hs-var">waveFuncCollapseStep</span></a></span></span><span> </span><span id="local-6989586621679056641"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056641"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span id="local-6989586621679056642"><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679056642"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679056643"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056643"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621679056644"><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679056644"><span class="hs-identifier hs-var">history</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056649"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056649"><span class="hs-identifier hs-var">newTiles</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056650"><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679056650"><span class="hs-identifier hs-var">weight</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056643"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Pos -&gt; ([Tile], Weights, Float)
forall k a. Ord k =&gt; Map k a -&gt; k -&gt; a
</span><span class="hs-operator hs-var">M.!</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056641"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-136"></span><span>  </span><span id="local-6989586621679056651"><span class="annot"><span class="annottext">Maybe Tile
</span><a href="#local-6989586621679056651"><span class="hs-identifier hs-var">tile</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; Weights -&gt; IO (Maybe Tile)
</span><a href="Gen.WaveFuncCollapse.html#randomTile"><span class="hs-identifier hs-var">randomTile</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056649"><span class="hs-identifier hs-var">newTiles</span></a></span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679056650"><span class="hs-identifier hs-var">weight</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Tile
</span><a href="#local-6989586621679056651"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><span class="annottext">Maybe Tile
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe (TileMap, Env), [HistoryUnit])
-&gt; IO (Maybe (TileMap, Env), [HistoryUnit])
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679056644"><span class="hs-identifier hs-var">history</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679056653"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056653"><span class="hs-identifier hs-var">tile</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><span id="line-140"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679056658"><span class="annot"><span class="annottext">newTileMap :: Map Pos Tile
</span><a href="#local-6989586621679056658"><span class="hs-identifier hs-var hs-var">newTileMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Tile -&gt; Map Pos Tile -&gt; Map Pos Tile
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056641"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056653"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679056642"><span class="hs-identifier hs-var">tileMap</span></a></span><span>
</span><span id="line-141"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679056659"><span class="annot"><span class="annottext">newHistory :: [HistoryUnit]
</span><a href="#local-6989586621679056659"><span class="hs-identifier hs-var hs-var">newHistory</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TileMap -&gt; Env -&gt; Pos -&gt; Tile -&gt; HistoryUnit
</span><a href="Gen.WaveFuncCollapse.html#HistoryUnit"><span class="hs-identifier hs-var">HistoryUnit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile -&gt; TileMap
</span><a href="Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679056642"><span class="hs-identifier hs-var">tileMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056643"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056641"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056653"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="annot"><span class="annottext">HistoryUnit -&gt; [HistoryUnit] -&gt; [HistoryUnit]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679056644"><span class="hs-identifier hs-var">history</span></a></span><span>
</span><span id="line-142"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679056664"><span class="annot"><span class="annottext">newEnv :: Env
</span><a href="#local-6989586621679056664"><span class="hs-identifier hs-var hs-var">newEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Env -&gt; Env
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.delete</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679056641"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056643"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-143"></span><span>      </span><span class="annot"><span class="annottext">(Maybe (TileMap, Env), [HistoryUnit])
-&gt; IO (Maybe (TileMap, Env), [HistoryUnit])
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TileMap -&gt; Env -&gt; Maybe (TileMap, Env)
</span><a href="Gen.WaveFuncCollapse.html#updateEnv"><span class="hs-identifier hs-var">updateEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile -&gt; TileMap
</span><a href="Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679056658"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056664"><span class="hs-identifier hs-var">newEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env)
-&gt; ((TileMap, Env) -&gt; Maybe (TileMap, Env)) -&gt; Maybe (TileMap, Env)
forall a b. Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679056666"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056666"><span class="hs-identifier hs-var">newTileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056667"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056667"><span class="hs-identifier hs-var">newEnv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TileMap, Env) -&gt; Maybe (TileMap, Env)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679056666"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679056667"><span class="hs-identifier hs-var">newEnv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679056659"><span class="hs-identifier hs-var">newHistory</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-comment">-- | Select a random tile from a list of tiles based on their weights.</span><span>
</span><span id="line-146"></span><span class="hs-comment">--   If the total weight is 0, the function will return Nothing.</span><span>
</span><span id="line-147"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#randomTile"><span class="hs-identifier hs-type">randomTile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span id="randomTile"><span class="annot"><span class="annottext">randomTile :: [Tile] -&gt; Weights -&gt; IO (Maybe Tile)
</span><a href="Gen.WaveFuncCollapse.html#randomTile"><span class="hs-identifier hs-var hs-var">randomTile</span></a></span></span><span> </span><span id="local-6989586621679056668"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056668"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056669"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056669"><span class="hs-identifier hs-var">totalWeight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679056670"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056670"><span class="hs-identifier hs-var">tilesWeight</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056669"><span class="hs-identifier hs-var">totalWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0.0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe Tile -&gt; IO (Maybe Tile)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Tile
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>        </span><span id="local-6989586621679056671"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056671"><span class="hs-identifier hs-var">randomNum</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Float, Float) -&gt; IO Float
forall a (m :: * -&gt; *). (Random a, MonadIO m) =&gt; (a, a) -&gt; m a
</span><span class="hs-identifier hs-var">randomRIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0.0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056669"><span class="hs-identifier hs-var">totalWeight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>        </span><span class="annot"><span class="annottext">Maybe Tile -&gt; IO (Maybe Tile)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Tile -&gt; IO (Maybe Tile)) -&gt; Maybe Tile -&gt; IO (Maybe Tile)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; [Float] -&gt; Float -&gt; Maybe Tile
</span><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var">weightToTile</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056668"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056670"><span class="hs-identifier hs-var">tilesWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056671"><span class="hs-identifier hs-var">randomNum</span></a></span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="hs-comment">-- | Convert a list of tiles and their weights to a single tile based on a random number.</span><span>
</span><span id="line-153"></span><span class="hs-comment">--  The function will return Nothing if list of tiles and weights are empty or the random number is </span><span>
</span><span id="line-154"></span><span class="hs-comment">--  greater than the total weight. The length of the tiles and weights must be the same.</span><span>
</span><span id="line-155"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-type">weightToTile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span>
</span><span id="line-156"></span><span id="weightToTile"><span class="annot"><span class="annottext">weightToTile :: [Tile] -&gt; [Float] -&gt; Float -&gt; Maybe Tile
</span><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var hs-var">weightToTile</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Tile
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-157"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var">weightToTile</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056673"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056673"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679056674"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056674"><span class="hs-identifier hs-var">tiles</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679056675"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056675"><span class="hs-identifier hs-var">weight</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679056676"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056676"><span class="hs-identifier hs-var">weights</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679056677"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056677"><span class="hs-identifier hs-var">randomNum</span></a></span></span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056677"><span class="hs-identifier hs-var">randomNum</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056675"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tile -&gt; Maybe Tile
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679056673"><span class="hs-identifier hs-var">tile</span></a></span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; [Float] -&gt; Float -&gt; Maybe Tile
</span><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var">weightToTile</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679056674"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679056676"><span class="hs-identifier hs-var">weights</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056677"><span class="hs-identifier hs-var">randomNum</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679056675"><span class="hs-identifier hs-var">weight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var">weightToTile</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Tile
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;WeightToTile: tiles and weights are not the same length&quot;</span></span><span>
</span><span id="line-161"></span></pre></body></html>