<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | The wave function collapse algorithm is a way to generate a tilemap based on a set of rules.</span><span>
</span><span id="line-2"></span><span class="hs-comment">--   The algorithm works by starting with a completely empty tilemap and then collapsing the wave function</span><span>
</span><span id="line-3"></span><span class="hs-comment">--   of each tile based on the rules and the surrounding tiles. This is done until the entire tilemap is filled.</span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Gen.WaveFuncCollapse</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse"><span class="hs-identifier">waveFuncCollapse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#waveFuncCollapeHeightMap"><span class="hs-identifier">waveFuncCollapeHeightMap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Internal.Def.html"><span class="hs-identifier">Internal.Def</span></a></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Def.html"><span class="hs-identifier">Def</span></a></span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random</span></span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-comment">-- | `Dependencies` is a map of positions to a list of positions. It is used to keep track of which positions</span><span>
</span><span id="line-13"></span><span class="hs-comment">--   are dependent on which other positions. An example of this is a tile which rules are dependent on its neighbours,</span><span>
</span><span id="line-14"></span><span class="hs-comment">---  the neighbours of this tile are then dependent on the tile itself, so the position of the tile is added to the</span><span>
</span><span id="line-15"></span><span class="hs-comment">--   list of dependencies of the neighbours.</span><span>
</span><span id="line-16"></span><span class="hs-keyword">type</span><span> </span><span id="Dependencies"><span class="annot"><a href="Gen.WaveFuncCollapse.html#Dependencies"><span class="hs-identifier hs-var">Dependencies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Internal.Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-17"></span><span class="annot"><span class="hs-comment">-- | Weights is a tuple of a float and a list of floats (Total weight, [Weights])</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">type</span><span> </span><span id="Weights"><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-var">Weights</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">type</span><span> </span><span id="ShannonEntropy"><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-var">ShannonEntropy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span>
</span><span id="line-20"></span><span class="hs-comment">-- | The `Env` is a map of positions to a tuple of a list of tiles, weights and shannon entropy.</span><span>
</span><span id="line-21"></span><span class="hs-comment">--   This is used to keep track of the possible tiles for each position and their weights.</span><span>
</span><span id="line-22"></span><span class="hs-keyword">type</span><span> </span><span id="Env"><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-var">Env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Internal.Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-type">ShannonEntropy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="annot"><span class="hs-comment">-- | The `History` is a list of `HistoryUnit` which is used to keep track of the history of the wave function collapse.</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">type</span><span> </span><span id="History"><span class="annot"><a href="Gen.WaveFuncCollapse.html#History"><span class="hs-identifier hs-var">History</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Gen.WaveFuncCollapse.html#HistoryUnit"><span class="hs-identifier hs-type">HistoryUnit</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-25"></span><span class="annot"><span class="hs-comment">-- | The `HistoryUnit` is a record of the tilemap, environment, dependencies, position and tile of a single step in the wave function collapse.</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">data</span><span> </span><span id="HistoryUnit"><span class="annot"><a href="Gen.WaveFuncCollapse.html#HistoryUnit"><span class="hs-identifier hs-var">HistoryUnit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="HistoryUnit"><span class="annot"><a href="Gen.WaveFuncCollapse.html#HistoryUnit"><span class="hs-identifier hs-var">HistoryUnit</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-27"></span><span>  </span><span id="prevTileMap"><span class="annot"><span class="annottext">HistoryUnit -&gt; TileMap
</span><a href="Gen.WaveFuncCollapse.html#prevTileMap"><span class="hs-identifier hs-var hs-var">prevTileMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>  </span><span id="prevEnv"><span class="annot"><span class="annottext">HistoryUnit -&gt; Env
</span><a href="Gen.WaveFuncCollapse.html#prevEnv"><span class="hs-identifier hs-var hs-var">prevEnv</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>  </span><span id="prevDependencies"><span class="annot"><span class="annottext">HistoryUnit -&gt; Dependencies
</span><a href="Gen.WaveFuncCollapse.html#prevDependencies"><span class="hs-identifier hs-var hs-var">prevDependencies</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Dependencies"><span class="hs-identifier hs-type">Dependencies</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>  </span><span id="placedPos"><span class="annot"><span class="annottext">HistoryUnit -&gt; Pos
</span><a href="Gen.WaveFuncCollapse.html#placedPos"><span class="hs-identifier hs-var hs-var">placedPos</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Internal.Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>  </span><span id="placedTile"><span class="annot"><span class="annottext">HistoryUnit -&gt; Tile
</span><a href="Gen.WaveFuncCollapse.html#placedTile"><span class="hs-identifier hs-var hs-var">placedTile</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span>
</span><span id="line-32"></span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679081996"><span id="local-6989586621679082010"><span id="local-6989586621679082014"><span class="annot"><span class="annottext">Int -&gt; HistoryUnit -&gt; ShowS
[HistoryUnit] -&gt; ShowS
HistoryUnit -&gt; Error
(Int -&gt; HistoryUnit -&gt; ShowS)
-&gt; (HistoryUnit -&gt; Error)
-&gt; ([HistoryUnit] -&gt; ShowS)
-&gt; Show HistoryUnit
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; Error) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; HistoryUnit -&gt; ShowS
showsPrec :: Int -&gt; HistoryUnit -&gt; ShowS
$cshow :: HistoryUnit -&gt; Error
show :: HistoryUnit -&gt; Error
$cshowList :: [HistoryUnit] -&gt; ShowS
showList :: [HistoryUnit] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-comment">-- | Run the wave function collapse algorithm on a list of tiles and a size for the world.</span><span>
</span><span id="line-35"></span><span class="hs-comment">--   The algorithm will return a tilemap that satisfies the rules of the tiles.</span><span>
</span><span id="line-36"></span><span class="hs-comment">--   If no possible tilemap can be generated, the function will return an error. </span><span>
</span><span id="line-37"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse"><span class="hs-identifier hs-type">waveFuncCollapse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-comment">-- ^ The tiles that will be placed in the tilemap </span></span><span>
</span><span id="line-38"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Internal.Def.html#Size"><span class="hs-identifier hs-type">Size</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ The size of the tilemap</span></span><span>
</span><span id="line-39"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Def.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span> </span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ Returns an error if no possible tilemap can be generated, otherwise returns the tilemap</span></span><span>
</span><span id="line-40"></span><span id="waveFuncCollapse"><span class="annot"><span class="annottext">waveFuncCollapse :: [Tile] -&gt; Size -&gt; IO (Either Error TileMap)
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse"><span class="hs-identifier hs-var hs-var">waveFuncCollapse</span></a></span></span><span> </span><span id="local-6989586621679082031"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082031"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span id="local-6989586621679082032"><span class="annot"><span class="annottext">size :: Size
</span><a href="#local-6989586621679082032"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679082033"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082033"><span class="hs-identifier hs-var">minX</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082034"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082034"><span class="hs-identifier hs-var">minY</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082035"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082035"><span class="hs-identifier hs-var">minZ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082036"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082036"><span class="hs-identifier hs-var">maxX</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082037"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082037"><span class="hs-identifier hs-var">maxY</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082038"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082038"><span class="hs-identifier hs-var">maxZ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679082043"><span class="annot"><span class="annottext">allPos :: [Pos]
</span><a href="#local-6989586621679082043"><span class="hs-identifier hs-var hs-var">allPos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082044"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082045"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082046"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679082044"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082044"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082033"><span class="hs-identifier hs-var">minX</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082036"><span class="hs-identifier hs-var">maxX</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082045"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082045"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082034"><span class="hs-identifier hs-var">minY</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082037"><span class="hs-identifier hs-var">maxY</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082046"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082046"><span class="hs-identifier hs-var">z</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082035"><span class="hs-identifier hs-var">minZ</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082038"><span class="hs-identifier hs-var">maxZ</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><span class="annottext">[Tile] -&gt; [Pos] -&gt; Size -&gt; IO (Either Error TileMap)
</span><a href="Gen.WaveFuncCollapse.html#waveFunc"><span class="hs-identifier hs-var">waveFunc</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082031"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">[Pos]
</span><a href="#local-6989586621679082043"><span class="hs-identifier hs-var">allPos</span></a></span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082032"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-comment">-- | Run the wave function collapse algorithm on a list of tiles and a list of positions.</span><span>
</span><span id="line-45"></span><span class="hs-comment">--   The algorithm will return a tilemap that satisfies the rules of the tiles.</span><span>
</span><span id="line-46"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#waveFunc"><span class="hs-identifier hs-type">waveFunc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Internal.Def.html#Size"><span class="hs-identifier hs-type">Size</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Def.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span> </span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span id="waveFunc"><span class="annot"><span class="annottext">waveFunc :: [Tile] -&gt; [Pos] -&gt; Size -&gt; IO (Either Error TileMap)
</span><a href="Gen.WaveFuncCollapse.html#waveFunc"><span class="hs-identifier hs-var hs-var">waveFunc</span></a></span></span><span> </span><span id="local-6989586621679082048"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082048"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span id="local-6989586621679082049"><span class="annot"><span class="annottext">[Pos]
</span><a href="#local-6989586621679082049"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621679082050"><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082050"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679082051"><span class="annot"><span class="annottext">emptyTileMap :: TileMap
</span><a href="#local-6989586621679082051"><span class="hs-identifier hs-var hs-var">emptyTileMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082050"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; TileMap -&gt; [Pos] -&gt; Maybe (TileMap, Env, Dependencies)
</span><a href="Gen.WaveFuncCollapse.html#createEnv"><span class="hs-identifier hs-var">createEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082048"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082051"><span class="hs-identifier hs-var">emptyTileMap</span></a></span><span> </span><span class="annot"><span class="annottext">[Pos]
</span><a href="#local-6989586621679082049"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Error TileMap -&gt; IO (Either Error TileMap)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either Error TileMap -&gt; IO (Either Error TileMap))
-&gt; Either Error TileMap -&gt; IO (Either Error TileMap)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Error -&gt; Either Error TileMap
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Error
</span><span class="hs-string">&quot;No possible tilemap can be generated&quot;</span></span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082055"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082055"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082056"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082056"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082057"><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082057"><span class="hs-identifier hs-var">dependencies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TileMap
-&gt; Env
-&gt; Dependencies
-&gt; [HistoryUnit]
-&gt; IO (Either Error TileMap)
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-var">waveFuncCollapse'</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082055"><span class="hs-identifier hs-var">tileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082056"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082057"><span class="hs-identifier hs-var">dependencies</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-comment">-- | Run the wave function collapse algorithm on a heightmap. The algorithm will generate a tilemap based on the heightmap</span><span>
</span><span id="line-54"></span><span class="hs-comment">--   and the rules of the tiles. The algorithm will return a tilemap that satisfies the rules of the tiles.</span><span>
</span><span id="line-55"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#waveFuncCollapeHeightMap"><span class="hs-identifier hs-type">waveFuncCollapeHeightMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Def.html#HeightMap"><span class="hs-identifier hs-type">HeightMap</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ The heightmap that the tilemap should be generated from</span></span><span>
</span><span id="line-56"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-comment">-- ^ The tiles that will be placed in the tilemap __above__ the heightmap</span></span><span>
</span><span id="line-57"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-comment">-- ^ The tiles that will be placed in the tilemap __below__ the heightmap</span></span><span>
</span><span id="line-58"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Internal.Def.html#Size"><span class="hs-identifier hs-type">Size</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The size of the tilemap</span></span><span>
</span><span id="line-59"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Def.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span> </span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ Returns an error if no possible tilemap can be generated, otherwise returns the tilemap</span></span><span>
</span><span id="line-60"></span><span id="waveFuncCollapeHeightMap"><span class="annot"><span class="annottext">waveFuncCollapeHeightMap :: HeightMap -&gt; [Tile] -&gt; [Tile] -&gt; Size -&gt; IO (Either Error TileMap)
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapeHeightMap"><span class="hs-identifier hs-var hs-var">waveFuncCollapeHeightMap</span></a></span></span><span> </span><span id="local-6989586621679082059"><span class="annot"><span class="annottext">HeightMap
</span><a href="#local-6989586621679082059"><span class="hs-identifier hs-var">heightMap</span></a></span></span><span> </span><span id="local-6989586621679082060"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082060"><span class="hs-identifier hs-var">airTiles</span></a></span></span><span> </span><span id="local-6989586621679082061"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082061"><span class="hs-identifier hs-var">groundTiles</span></a></span></span><span> </span><span id="local-6989586621679082062"><span class="annot"><span class="annottext">size :: Size
</span><a href="#local-6989586621679082062"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679082063"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082063"><span class="hs-identifier hs-var">minX</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082064"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082064"><span class="hs-identifier hs-var">minY</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082065"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082065"><span class="hs-identifier hs-var">minZ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082066"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082066"><span class="hs-identifier hs-var">maxX</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082067"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082067"><span class="hs-identifier hs-var">maxY</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082068"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082068"><span class="hs-identifier hs-var">maxZ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679082076"><span class="annot"><span class="annottext">xz :: [(Int, Float, Int)]
</span><a href="#local-6989586621679082076"><span class="hs-identifier hs-var hs-var">xz</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082077"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeightMap
</span><a href="#local-6989586621679082059"><span class="hs-identifier hs-var">heightMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Float
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082077"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Float
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082078"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082078"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679082077"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082077"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082063"><span class="hs-identifier hs-var">minX</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082066"><span class="hs-identifier hs-var">maxX</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082078"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082078"><span class="hs-identifier hs-var">z</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082065"><span class="hs-identifier hs-var">minZ</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082068"><span class="hs-identifier hs-var">maxZ</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679082094"><span class="annot"><span class="annottext">groundPos :: [Pos]
</span><a href="#local-6989586621679082094"><span class="hs-identifier hs-var hs-var">groundPos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082095"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082096"><span class="hs-identifier hs-var">y'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082097"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082095"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082095"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082098"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082098"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082097"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082097"><span class="hs-identifier hs-var">z</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Int, Float, Int)]
</span><a href="#local-6989586621679082076"><span class="hs-identifier hs-var">xz</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082096"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082096"><span class="hs-identifier hs-var">y'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082064"><span class="hs-identifier hs-var">minY</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Float -&gt; Int
forall b. Integral b =&gt; Float -&gt; b
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">round</span></span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Float
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082067"><span class="hs-identifier hs-var">maxY</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Float
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082067"><span class="hs-identifier hs-var">maxY</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Float
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082064"><span class="hs-identifier hs-var">minY</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082098"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679082113"><span class="annot"><span class="annottext">airPos :: [Pos]
</span><a href="#local-6989586621679082113"><span class="hs-identifier hs-var hs-var">airPos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082114"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082115"><span class="hs-identifier hs-var">y'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082116"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082114"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082114"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082117"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082117"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082116"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082116"><span class="hs-identifier hs-var">z</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Int, Float, Int)]
</span><a href="#local-6989586621679082076"><span class="hs-identifier hs-var">xz</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082115"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082115"><span class="hs-identifier hs-var">y'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Float -&gt; Int
forall b. Integral b =&gt; Float -&gt; b
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">round</span></span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Float
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082064"><span class="hs-identifier hs-var">minY</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082117"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Float
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082067"><span class="hs-identifier hs-var">maxY</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Float
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082064"><span class="hs-identifier hs-var">minY</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082067"><span class="hs-identifier hs-var">maxY</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-64"></span><span>  </span><span id="local-6989586621679082119"><span class="annot"><span class="annottext">Either Error TileMap
</span><a href="#local-6989586621679082119"><span class="hs-identifier hs-var">groundResult</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; [Pos] -&gt; Size -&gt; IO (Either Error TileMap)
</span><a href="Gen.WaveFuncCollapse.html#waveFunc"><span class="hs-identifier hs-var">waveFunc</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082061"><span class="hs-identifier hs-var">groundTiles</span></a></span><span> </span><span class="annot"><span class="annottext">[Pos]
</span><a href="#local-6989586621679082094"><span class="hs-identifier hs-var">groundPos</span></a></span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082062"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-65"></span><span>  </span><span id="local-6989586621679082120"><span class="annot"><span class="annottext">Either Error TileMap
</span><a href="#local-6989586621679082120"><span class="hs-identifier hs-var">airResult</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; [Pos] -&gt; Size -&gt; IO (Either Error TileMap)
</span><a href="Gen.WaveFuncCollapse.html#waveFunc"><span class="hs-identifier hs-var">waveFunc</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082060"><span class="hs-identifier hs-var">airTiles</span></a></span><span> </span><span class="annot"><span class="annottext">[Pos]
</span><a href="#local-6989586621679082113"><span class="hs-identifier hs-var">airPos</span></a></span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082062"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-66"></span><span>  </span><span class="annot"><span class="annottext">Either Error TileMap -&gt; IO (Either Error TileMap)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either Error TileMap -&gt; IO (Either Error TileMap))
-&gt; Either Error TileMap -&gt; IO (Either Error TileMap)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082121"><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082121"><span class="hs-identifier hs-var">groundTileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either Error TileMap
</span><a href="#local-6989586621679082119"><span class="hs-identifier hs-var">groundResult</span></a></span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082122"><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082122"><span class="hs-identifier hs-var">airTileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either Error TileMap
</span><a href="#local-6989586621679082120"><span class="hs-identifier hs-var">airResult</span></a></span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><span class="annottext">TileMap -&gt; Either Error TileMap
forall a. a -&gt; Either Error a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(TileMap -&gt; Either Error TileMap)
-&gt; TileMap -&gt; Either Error TileMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile -&gt; Map Pos Tile -&gt; Map Pos Tile
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.union</span></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082121"><span class="hs-identifier hs-var">groundTileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082122"><span class="hs-identifier hs-var">airTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082062"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-comment">-- | Create the tileMap and environment for the wave function collapse algorithm</span><span>
</span><span id="line-72"></span><span class="hs-comment">--   It applies the rule to each position and creates the environment based on the result.</span><span>
</span><span id="line-73"></span><span class="hs-comment">--   If an environment only has one possible tile it will be added to the tileMap, </span><span>
</span><span id="line-74"></span><span class="hs-comment">--   and removed from the environment. If an environment has no possible tiles, the function will return Nothing.</span><span>
</span><span id="line-75"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#createEnv"><span class="hs-identifier hs-type">createEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Dependencies"><span class="hs-identifier hs-type">Dependencies</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span id="createEnv"><span class="annot"><span class="annottext">createEnv :: [Tile] -&gt; TileMap -&gt; [Pos] -&gt; Maybe (TileMap, Env, Dependencies)
</span><a href="Gen.WaveFuncCollapse.html#createEnv"><span class="hs-identifier hs-var hs-var">createEnv</span></a></span></span><span> </span><span id="local-6989586621679082124"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082124"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span id="local-6989586621679082125"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082125"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Pos
 -&gt; Maybe (TileMap, Env, Dependencies)
 -&gt; Maybe (TileMap, Env, Dependencies))
-&gt; Maybe (TileMap, Env, Dependencies)
-&gt; [Pos]
-&gt; Maybe (TileMap, Env, Dependencies)
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679082127"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082127"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621679082128"><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
</span><a href="#local-6989586621679082128"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
</span><a href="#local-6989586621679082128"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><span id="line-77"></span><span>  </span><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-78"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082129"><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082129"><span class="hs-identifier hs-var">newTileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082130"><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082130"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082131"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082131"><span class="hs-identifier hs-var">newEnv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082132"><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082132"><span class="hs-identifier hs-var">newDependencies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Pos
-&gt; [Tile]
-&gt; TileMap
-&gt; Dependencies
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
</span><a href="Gen.WaveFuncCollapse.html#posToEnv"><span class="hs-identifier hs-var">posToEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082127"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082124"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082129"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082130"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082132"><span class="hs-identifier hs-var">newDependencies</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-79"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Either Tile ([Tile], Weights, Float))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-80"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679082134"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082134"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TileMap, Env, Dependencies) -&gt; Maybe (TileMap, Env, Dependencies)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos -&gt; Tile -&gt; Map Pos Tile -&gt; Map Pos Tile
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082127"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082134"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082129"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082130"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082131"><span class="hs-identifier hs-var">newEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Tile -&gt; TileMap -&gt; Dependencies -&gt; Dependencies
</span><a href="Gen.WaveFuncCollapse.html#updateDependencies"><span class="hs-identifier hs-var">updateDependencies</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082127"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082134"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082129"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082130"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082132"><span class="hs-identifier hs-var">newDependencies</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679082137"><span class="annot"><span class="annottext">([Tile], Weights, Float)
</span><a href="#local-6989586621679082137"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TileMap, Env, Dependencies) -&gt; Maybe (TileMap, Env, Dependencies)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082129"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082130"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; ([Tile], Weights, Float) -&gt; Env -&gt; Env
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082127"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">([Tile], Weights, Float)
</span><a href="#local-6989586621679082137"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082131"><span class="hs-identifier hs-var">newEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082132"><span class="hs-identifier hs-var">newDependencies</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TileMap, Env, Dependencies) -&gt; Maybe (TileMap, Env, Dependencies)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082125"><span class="hs-identifier hs-var">tileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependencies
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-comment">-- | Update the environment with the new possible tiles and their weights. </span><span>
</span><span id="line-85"></span><span class="hs-comment">--   It applies the rule to each possible tile and removes the tile from the environment if it doesn't satisfy the rules.</span><span>
</span><span id="line-86"></span><span class="hs-comment">--   If the environment has only one possible tile it will be added to the tileMap and removed from the environment. </span><span>
</span><span id="line-87"></span><span class="hs-comment">--   If the environment has no possible tiles, the function will return Nothing.</span><span>
</span><span id="line-88"></span><span class="hs-comment">--   Also updates the dependencies of the positions based on the new tile.</span><span>
</span><span id="line-89"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#updateEnv"><span class="hs-identifier hs-type">updateEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Dependencies"><span class="hs-identifier hs-type">Dependencies</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Dependencies"><span class="hs-identifier hs-type">Dependencies</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span id="updateEnv"><span class="annot"><span class="annottext">updateEnv :: TileMap
-&gt; Env -&gt; Dependencies -&gt; Maybe (TileMap, Env, Dependencies)
</span><a href="Gen.WaveFuncCollapse.html#updateEnv"><span class="hs-identifier hs-var hs-var">updateEnv</span></a></span></span><span> </span><span id="local-6989586621679082139"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082139"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span> </span><span id="local-6989586621679082140"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082140"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621679082141"><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082141"><span class="hs-identifier hs-var">dependencies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Pos
 -&gt; Maybe (TileMap, Env, Dependencies)
 -&gt; Maybe (TileMap, Env, Dependencies))
-&gt; Maybe (TileMap, Env, Dependencies)
-&gt; [Pos]
-&gt; Maybe (TileMap, Env, Dependencies)
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679082142"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082142"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621679082143"><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
</span><a href="#local-6989586621679082143"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
</span><a href="#local-6989586621679082143"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082144"><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082144"><span class="hs-identifier hs-var">newTileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082145"><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082145"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082146"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082146"><span class="hs-identifier hs-var">newEnv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082147"><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082147"><span class="hs-identifier hs-var">newDependencies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082152"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082152"><span class="hs-identifier hs-var">tiles</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082140"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Pos -&gt; ([Tile], Weights, Float)
forall k a. Ord k =&gt; Map k a -&gt; k -&gt; a
</span><span class="hs-operator hs-var">M.!</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082142"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Pos
-&gt; [Tile]
-&gt; TileMap
-&gt; Dependencies
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
</span><a href="Gen.WaveFuncCollapse.html#posToEnv"><span class="hs-identifier hs-var">posToEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082142"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082152"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082144"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082145"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082147"><span class="hs-identifier hs-var">newDependencies</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-94"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Either Tile ([Tile], Weights, Float))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-95"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679082154"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082154"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TileMap, Env, Dependencies) -&gt; Maybe (TileMap, Env, Dependencies)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos -&gt; Tile -&gt; Map Pos Tile -&gt; Map Pos Tile
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082142"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082154"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082144"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082145"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082146"><span class="hs-identifier hs-var">newEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Tile -&gt; TileMap -&gt; Dependencies -&gt; Dependencies
</span><a href="Gen.WaveFuncCollapse.html#updateDependencies"><span class="hs-identifier hs-var">updateDependencies</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082142"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082154"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082144"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082145"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082147"><span class="hs-identifier hs-var">newDependencies</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679082155"><span class="annot"><span class="annottext">([Tile], Weights, Float)
</span><a href="#local-6989586621679082155"><span class="hs-identifier hs-var">newPosEnv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TileMap, Env, Dependencies) -&gt; Maybe (TileMap, Env, Dependencies)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082144"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082145"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; ([Tile], Weights, Float) -&gt; Env -&gt; Env
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082142"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">([Tile], Weights, Float)
</span><a href="#local-6989586621679082155"><span class="hs-identifier hs-var">newPosEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082146"><span class="hs-identifier hs-var">newEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082147"><span class="hs-identifier hs-var">newDependencies</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TileMap, Env, Dependencies) -&gt; Maybe (TileMap, Env, Dependencies)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082139"><span class="hs-identifier hs-var">tileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082141"><span class="hs-identifier hs-var">dependencies</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env -&gt; [Pos]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082140"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-comment">-- | Calculates the new environment for a position. It applies the rules to the position and returns the possible tiles</span><span>
</span><span id="line-100"></span><span class="hs-comment">--   and their weights. If the environment has only one possible tile it will return a `Left Tile`, otherwise it will return</span><span>
</span><span id="line-101"></span><span class="hs-comment">--   a `Right ([Tile], Weights, ShannonEntropy)`. If the environment has no possible tiles, the function will return Nothing.</span><span>
</span><span id="line-102"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#posToEnv"><span class="hs-identifier hs-type">posToEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Internal.Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Dependencies"><span class="hs-identifier hs-type">Dependencies</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-type">ShannonEntropy</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-103"></span><span id="posToEnv"><span class="annot"><span class="annottext">posToEnv :: Pos
-&gt; [Tile]
-&gt; TileMap
-&gt; Dependencies
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
</span><a href="Gen.WaveFuncCollapse.html#posToEnv"><span class="hs-identifier hs-var hs-var">posToEnv</span></a></span></span><span> </span><span id="local-6989586621679082157"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082157"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621679082158"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082158"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082159"><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082159"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082160"><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082160"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679082161"><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082161"><span class="hs-identifier hs-var">dependencies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679082162"><span class="annot"><span class="annottext">weights :: [Float]
</span><a href="#local-6989586621679082162"><span class="hs-identifier hs-var hs-var">weights</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Tile -&gt; Float) -&gt; [Tile] -&gt; [Float]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleResult -&gt; Float
</span><a href="Def.html#resultToFloat"><span class="hs-identifier hs-var">resultToFloat</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleResult -&gt; Float) -&gt; (Tile -&gt; RuleResult) -&gt; Tile -&gt; Float
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RuleMonad RuleResult -&gt; RuleResult
forall a. RuleMonad a -&gt; a
</span><a href="Internal.Def.html#getVal"><span class="hs-identifier hs-var">getVal</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleMonad RuleResult -&gt; RuleResult)
-&gt; (Tile -&gt; RuleMonad RuleResult) -&gt; Tile -&gt; RuleResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Internal.Def.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span id="local-6989586621679082167"><span class="annot"><span class="annottext">TileMap -&gt; Pos -&gt; RuleMonad RuleResult
</span><a href="#local-6989586621679082167"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TileMap -&gt; Pos -&gt; RuleMonad RuleResult
</span><a href="#local-6989586621679082167"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082159"><span class="hs-identifier hs-var">tileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082160"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082157"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Rule -&gt; RuleMonad RuleResult)
-&gt; (Tile -&gt; Rule) -&gt; Tile -&gt; RuleMonad RuleResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Tile -&gt; Rule
</span><a href="Internal.Def.html#rules"><span class="hs-identifier hs-var">rules</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082158"><span class="hs-identifier hs-var">tiles</span></a></span><span>
</span><span id="line-105"></span><span>      </span><span class="hs-comment">-- Only keep the tiles that have a weight greater than 0 and still satisfy the rules</span><span>
</span><span id="line-106"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679082180"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082180"><span class="hs-identifier hs-var">newTiles</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082181"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082181"><span class="hs-identifier hs-var">newWeights</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Tile, Float)] -&gt; ([Tile], [Float])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Tile, Float)] -&gt; ([Tile], [Float]))
-&gt; [(Tile, Float)] -&gt; ([Tile], [Float])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Tile, Float) -&gt; Bool) -&gt; [(Tile, Float)] -&gt; [(Tile, Float)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679082183"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082183"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082184"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082184"><span class="hs-identifier hs-var">weight</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082184"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span>
</span><span id="line-107"></span><span>        </span><span class="hs-comment">-- Check if the depencies of the tile still satisfy the rules if the tile is placed at the position</span><span>
</span><span id="line-108"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Dependencies -&gt; Maybe [Pos]
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082157"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082161"><span class="hs-identifier hs-var">dependencies</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><span id="line-109"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679082188"><span class="annot"><span class="annottext">[Pos]
</span><a href="#local-6989586621679082188"><span class="hs-identifier hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Pos -&gt; Bool) -&gt; [Pos] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679082190"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082190"><span class="hs-identifier hs-var">pos'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span>
</span><span id="line-110"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; (Tile -&gt; Bool) -&gt; Maybe Tile -&gt; Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0</span></span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Float -&gt; Bool) -&gt; (Tile -&gt; Float) -&gt; Tile -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RuleResult -&gt; Float
</span><a href="Def.html#resultToFloat"><span class="hs-identifier hs-var">resultToFloat</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleResult -&gt; Float) -&gt; (Tile -&gt; RuleResult) -&gt; Tile -&gt; Float
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RuleMonad RuleResult -&gt; RuleResult
forall a. RuleMonad a -&gt; a
</span><a href="Internal.Def.html#getVal"><span class="hs-identifier hs-var">getVal</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleMonad RuleResult -&gt; RuleResult)
-&gt; (Tile -&gt; RuleMonad RuleResult) -&gt; Tile -&gt; RuleResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Internal.Def.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span id="local-6989586621679082193"><span class="annot"><span class="annottext">TileMap -&gt; Pos -&gt; RuleMonad RuleResult
</span><a href="#local-6989586621679082193"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TileMap -&gt; Pos -&gt; RuleMonad RuleResult
</span><a href="#local-6989586621679082193"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos -&gt; Tile -&gt; Map Pos Tile -&gt; Map Pos Tile
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082157"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082183"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082159"><span class="hs-identifier hs-var">tileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082160"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082190"><span class="hs-identifier hs-var">pos'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Rule -&gt; RuleMonad RuleResult)
-&gt; (Tile -&gt; Rule) -&gt; Tile -&gt; RuleMonad RuleResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Tile -&gt; Rule
</span><a href="Internal.Def.html#rules"><span class="hs-identifier hs-var">rules</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos -&gt; Map Pos Tile -&gt; Maybe Tile
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082190"><span class="hs-identifier hs-var">pos'</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082159"><span class="hs-identifier hs-var">tileMap</span></a></span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-111"></span><span>              </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Pos]
</span><a href="#local-6989586621679082188"><span class="hs-identifier hs-var">deps</span></a></span><span>
</span><span id="line-112"></span><span>          </span><span class="annot"><span class="annottext">Maybe [Pos]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Tile, Float)] -&gt; [(Tile, Float)])
-&gt; [(Tile, Float)] -&gt; [(Tile, Float)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; [Float] -&gt; [(Tile, Float)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082158"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082162"><span class="hs-identifier hs-var">weights</span></a></span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082180"><span class="hs-identifier hs-var">newTiles</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Either Tile ([Tile], Weights, Float))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-special">[</span><span id="local-6989586621679082194"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082194"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Tile ([Tile], Weights, Float)
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Either Tile ([Tile], Weights, Float)
 -&gt; Maybe (Either Tile ([Tile], Weights, Float)))
-&gt; Either Tile ([Tile], Weights, Float)
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tile -&gt; Either Tile ([Tile], Weights, Float)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082194"><span class="hs-identifier hs-var">tile</span></a></span><span>
</span><span id="line-116"></span><span>    </span><span class="annot"><span class="annottext">[Tile]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-117"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679082197"><span class="annot"><span class="annottext">totWeight :: Float
</span><a href="#local-6989586621679082197"><span class="hs-identifier hs-var hs-var">totWeight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Float] -&gt; Float
forall a. Num a =&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082181"><span class="hs-identifier hs-var">newWeights</span></a></span><span>
</span><span id="line-118"></span><span>      </span><span class="annot"><span class="annottext">Either Tile ([Tile], Weights, Float)
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Either Tile ([Tile], Weights, Float)
 -&gt; Maybe (Either Tile ([Tile], Weights, Float)))
-&gt; Either Tile ([Tile], Weights, Float)
-&gt; Maybe (Either Tile ([Tile], Weights, Float))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([Tile], Weights, Float) -&gt; Either Tile ([Tile], Weights, Float)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082180"><span class="hs-identifier hs-var">newTiles</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082197"><span class="hs-identifier hs-var">totWeight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082181"><span class="hs-identifier hs-var">newWeights</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights -&gt; Float
</span><a href="Gen.WaveFuncCollapse.html#shannonEntropy"><span class="hs-identifier hs-var">shannonEntropy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082197"><span class="hs-identifier hs-var">totWeight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082181"><span class="hs-identifier hs-var">newWeights</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-comment">-- | Calculate the shannon entropy of a set of tiles. We use type `Weights` instead of a list of tiles</span><span>
</span><span id="line-121"></span><span class="hs-comment">--   to avoid reevaluating the rules of the tiles and recalculating the total weight of these tiles.</span><span>
</span><span id="line-122"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#shannonEntropy"><span class="hs-identifier hs-type">shannonEntropy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-type">ShannonEntropy</span></a></span><span>
</span><span id="line-123"></span><span id="shannonEntropy"><span class="annot"><span class="annottext">shannonEntropy :: Weights -&gt; Float
</span><a href="Gen.WaveFuncCollapse.html#shannonEntropy"><span class="hs-identifier hs-var hs-var">shannonEntropy</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082200"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082200"><span class="hs-identifier hs-var">totWeight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082201"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082201"><span class="hs-identifier hs-var">weights</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float
forall a. Floating a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">log</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082200"><span class="hs-identifier hs-var">totWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082203"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082200"><span class="hs-identifier hs-var">totWeight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-125"></span><span>    </span><span id="local-6989586621679082203"><span class="annot"><span class="annottext">h :: Float
</span><a href="#local-6989586621679082203"><span class="hs-identifier hs-var hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Float -&gt; Float -&gt; Float) -&gt; Float -&gt; [Float] -&gt; Float
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679082210"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082210"><span class="hs-identifier hs-var">weight</span></a></span></span><span> </span><span id="local-6989586621679082211"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082211"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082211"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082210"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span>  </span><span class="annot"><span class="annottext">Float -&gt; Float
forall a. Floating a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">log</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082210"><span class="hs-identifier hs-var">weight</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082201"><span class="hs-identifier hs-var">weights</span></a></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">-- | The helper function of the `waveFuncCollape` function. It will iteratively call the `waveFuncCollapseStep`</span><span>
</span><span id="line-128"></span><span class="hs-comment">--   function until there are no more available positions in the environment. This function is called with the </span><span>
</span><span id="line-129"></span><span class="hs-comment">--   position where the wave function should collapse. This position is generated using the `shannonPos` </span><span>
</span><span id="line-130"></span><span class="hs-comment">--   function. If the algorithm gets stuck, it will call the `resetWaveFuncCollapse` function. </span><span>
</span><span id="line-131"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-type">waveFuncCollapse'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Dependencies"><span class="hs-identifier hs-type">Dependencies</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#History"><span class="hs-identifier hs-type">History</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Def.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span> </span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span id="waveFuncCollapse%27"><span class="annot"><span class="annottext">waveFuncCollapse' :: TileMap
-&gt; Env
-&gt; Dependencies
-&gt; [HistoryUnit]
-&gt; IO (Either Error TileMap)
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-var hs-var">waveFuncCollapse'</span></a></span></span><span> </span><span id="local-6989586621679082215"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082215"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span> </span><span id="local-6989586621679082216"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082216"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621679082217"><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082217"><span class="hs-identifier hs-var">dependencies</span></a></span></span><span> </span><span id="local-6989586621679082218"><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679082218"><span class="hs-identifier hs-var">history</span></a></span></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Env -&gt; Bool
forall k a. Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">M.null</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082216"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either Error TileMap -&gt; IO (Either Error TileMap)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either Error TileMap -&gt; IO (Either Error TileMap))
-&gt; Either Error TileMap -&gt; IO (Either Error TileMap)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TileMap -&gt; Either Error TileMap
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082215"><span class="hs-identifier hs-var">tileMap</span></a></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-135"></span><span>    </span><span id="local-6989586621679082220"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082220"><span class="hs-identifier hs-var">randomPos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; IO Pos
</span><a href="Gen.WaveFuncCollapse.html#shannonPos"><span class="hs-identifier hs-var">shannonPos</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082216"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679082221"><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
</span><a href="#local-6989586621679082221"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082222"><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679082222"><span class="hs-identifier hs-var">newHistory</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pos
-&gt; TileMap
-&gt; Env
-&gt; Dependencies
-&gt; [HistoryUnit]
-&gt; IO (Maybe (TileMap, Env, Dependencies), [HistoryUnit])
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapseStep"><span class="hs-identifier hs-var">waveFuncCollapseStep</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082220"><span class="hs-identifier hs-var">randomPos</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082215"><span class="hs-identifier hs-var">tileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082216"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082217"><span class="hs-identifier hs-var">dependencies</span></a></span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679082218"><span class="hs-identifier hs-var">history</span></a></span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
</span><a href="#local-6989586621679082221"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-138"></span><span>      </span><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[HistoryUnit] -&gt; IO (Either Error TileMap)
</span><a href="Gen.WaveFuncCollapse.html#resetWaveFuncCollapse"><span class="hs-identifier hs-var">resetWaveFuncCollapse</span></a></span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679082222"><span class="hs-identifier hs-var">newHistory</span></a></span><span>
</span><span id="line-139"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082223"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082223"><span class="hs-identifier hs-var">newTileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082224"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082224"><span class="hs-identifier hs-var">newEnv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082225"><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082225"><span class="hs-identifier hs-var">newDependencies</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TileMap
-&gt; Env
-&gt; Dependencies
-&gt; [HistoryUnit]
-&gt; IO (Either Error TileMap)
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-var">waveFuncCollapse'</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082223"><span class="hs-identifier hs-var">newTileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082224"><span class="hs-identifier hs-var">newEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082225"><span class="hs-identifier hs-var">newDependencies</span></a></span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679082222"><span class="hs-identifier hs-var">newHistory</span></a></span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span class="hs-comment">-- | Reset the wave function collapse algorithm. This is done when the algorithm gets stuck and can't continue.</span><span>
</span><span id="line-142"></span><span class="hs-comment">--   Not implemented yet. Optimally the algorithm should be able to backtrack to a previously solvable state.</span><span>
</span><span id="line-143"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#resetWaveFuncCollapse"><span class="hs-identifier hs-type">resetWaveFuncCollapse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#History"><span class="hs-identifier hs-type">History</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Def.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span> </span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span id="resetWaveFuncCollapse"><span class="annot"><span class="annottext">resetWaveFuncCollapse :: [HistoryUnit] -&gt; IO (Either Error TileMap)
</span><a href="Gen.WaveFuncCollapse.html#resetWaveFuncCollapse"><span class="hs-identifier hs-var hs-var">resetWaveFuncCollapse</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either Error TileMap -&gt; IO (Either Error TileMap)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either Error TileMap -&gt; IO (Either Error TileMap))
-&gt; Either Error TileMap -&gt; IO (Either Error TileMap)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Error -&gt; Either Error TileMap
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Error
</span><span class="hs-string">&quot;No possible tilemap can be generated&quot;</span></span><span>
</span><span id="line-145"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#resetWaveFuncCollapse"><span class="hs-identifier hs-var">resetWaveFuncCollapse</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Gen.WaveFuncCollapse.html#HistoryUnit"><span class="hs-identifier hs-type">HistoryUnit</span></a></span><span> </span><span id="local-6989586621679082226"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082226"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span> </span><span id="local-6989586621679082227"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082227"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621679082228"><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082228"><span class="hs-identifier hs-var">dependencies</span></a></span></span><span> </span><span id="local-6989586621679082229"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082229"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621679082230"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082230"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679082231"><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679082231"><span class="hs-identifier hs-var">history</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679082236"><span class="annot"><span class="annottext">newEnv :: Env
</span><a href="#local-6989586621679082236"><span class="hs-identifier hs-var hs-var">newEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(([Tile], Weights, Float) -&gt; ([Tile], Weights, Float))
-&gt; Pos -&gt; Env -&gt; Env
forall k a. Ord k =&gt; (a -&gt; a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.adjust</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679082238"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082238"><span class="hs-identifier hs-var">tiles</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082239"><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679082239"><span class="hs-identifier hs-var">weights</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082240"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082240"><span class="hs-identifier hs-var">newTiles</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082241"><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679082241"><span class="hs-identifier hs-var">newWeights</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tile -&gt; ([Tile], Weights) -&gt; ([Tile], Weights)
</span><a href="Gen.WaveFuncCollapse.html#deleteTile"><span class="hs-identifier hs-var">deleteTile</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082230"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082238"><span class="hs-identifier hs-var">tiles</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679082239"><span class="hs-identifier hs-var">weights</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082240"><span class="hs-identifier hs-var">newTiles</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679082241"><span class="hs-identifier hs-var">newWeights</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights -&gt; Float
</span><a href="Gen.WaveFuncCollapse.html#shannonEntropy"><span class="hs-identifier hs-var">shannonEntropy</span></a></span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679082241"><span class="hs-identifier hs-var">newWeights</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082229"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082227"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082247"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082247"><span class="hs-identifier hs-var">newTiles</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082236"><span class="hs-identifier hs-var">newEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Pos -&gt; ([Tile], Weights, Float)
forall k a. Ord k =&gt; Map k a -&gt; k -&gt; a
</span><span class="hs-operator hs-var">M.!</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082229"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082247"><span class="hs-identifier hs-var">newTiles</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[HistoryUnit] -&gt; IO (Either Error TileMap)
</span><a href="Gen.WaveFuncCollapse.html#resetWaveFuncCollapse"><span class="hs-identifier hs-var">resetWaveFuncCollapse</span></a></span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679082231"><span class="hs-identifier hs-var">history</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TileMap
-&gt; Env
-&gt; Dependencies
-&gt; [HistoryUnit]
-&gt; IO (Either Error TileMap)
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapse%27"><span class="hs-identifier hs-var">waveFuncCollapse'</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082226"><span class="hs-identifier hs-var">tileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082236"><span class="hs-identifier hs-var">newEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082228"><span class="hs-identifier hs-var">dependencies</span></a></span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679082231"><span class="hs-identifier hs-var">history</span></a></span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span class="hs-comment">-- | Delete a tile from a list of tiles and their weights. The function will return a new list of tiles and weights</span><span>
</span><span id="line-151"></span><span class="hs-comment">--   where the tile has been removed. If the tile is not in the list, the function will throw an error.</span><span>
</span><span id="line-152"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#deleteTile"><span class="hs-identifier hs-type">deleteTile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span id="deleteTile"><span class="annot"><span class="annottext">deleteTile :: Tile -&gt; ([Tile], Weights) -&gt; ([Tile], Weights)
</span><a href="Gen.WaveFuncCollapse.html#deleteTile"><span class="hs-identifier hs-var hs-var">deleteTile</span></a></span></span><span> </span><span id="local-6989586621679082249"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082249"><span class="hs-identifier hs-var">tile</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082250"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082250"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679082251"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082251"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082252"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082252"><span class="hs-identifier hs-var">totalWeight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082253"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082253"><span class="hs-identifier hs-var">y</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679082254"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082254"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082250"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Tile -&gt; Tile -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082249"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082251"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082252"><span class="hs-identifier hs-var">totalWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082253"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082254"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679082255"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082255"><span class="hs-identifier hs-var">newTiles'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082256"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082256"><span class="hs-identifier hs-var">totalWeight'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082257"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082257"><span class="hs-identifier hs-var">weights</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082250"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">Tile -&gt; [Tile] -&gt; [Tile]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082255"><span class="hs-identifier hs-var">newTiles'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082256"><span class="hs-identifier hs-var">totalWeight'</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082253"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082253"><span class="hs-identifier hs-var">y</span></a></span><span class="annot"><span class="annottext">Float -&gt; [Float] -&gt; [Float]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082257"><span class="hs-identifier hs-var">weights</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([Tile], Weights) -&gt; ([Tile], Weights))
-&gt; ([Tile], Weights) -&gt; ([Tile], Weights)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Tile -&gt; ([Tile], Weights) -&gt; ([Tile], Weights)
</span><a href="Gen.WaveFuncCollapse.html#deleteTile"><span class="hs-identifier hs-var">deleteTile</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082249"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082251"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082252"><span class="hs-identifier hs-var">totalWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082253"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082254"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-156"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#deleteTile"><span class="hs-identifier hs-var">deleteTile</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">([Tile], Weights)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Error -&gt; ([Tile], Weights)
forall a. HasCallStack =&gt; Error -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">Error
</span><span class="hs-string">&quot;Tile not in list&quot;</span></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span class="hs-comment">-- | Get the position with the lowest shannon entropy. If there are multiple positions with the same entropy,</span><span>
</span><span id="line-159"></span><span class="hs-comment">--   the function will return a random position from the list of positions.</span><span>
</span><span id="line-160"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#shannonPos"><span class="hs-identifier hs-type">shannonPos</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Internal.Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span>
</span><span id="line-161"></span><span id="shannonPos"><span class="annot"><span class="annottext">shannonPos :: Env -&gt; IO Pos
</span><a href="Gen.WaveFuncCollapse.html#shannonPos"><span class="hs-identifier hs-var hs-var">shannonPos</span></a></span></span><span> </span><span id="local-6989586621679082259"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082259"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Pos] -&gt; IO Pos
forall a. [a] -&gt; IO a
</span><a href="Gen.WaveFuncCollapse.html#getRandomElement"><span class="hs-identifier hs-var">getRandomElement</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Float, [Pos]) -&gt; [Pos]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Pos
 -&gt; ([Tile], Weights, Float) -&gt; (Float, [Pos]) -&gt; (Float, [Pos]))
-&gt; (Float, [Pos]) -&gt; Env -&gt; (Float, [Pos])
forall k a b. (k -&gt; a -&gt; b -&gt; b) -&gt; b -&gt; Map k a -&gt; b
</span><span class="hs-identifier hs-var">M.foldrWithKey</span></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; ([Tile], Weights, Float) -&gt; (Float, [Pos]) -&gt; (Float, [Pos])
</span><a href="#local-6989586621679082263"><span class="hs-identifier hs-var">minList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082259"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-163"></span><span>    </span><span class="annot"><a href="#local-6989586621679082263"><span class="hs-identifier hs-type">minList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Internal.Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-type">ShannonEntropy</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-type">ShannonEntropy</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Gen.WaveFuncCollapse.html#ShannonEntropy"><span class="hs-identifier hs-type">ShannonEntropy</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-164"></span><span>    </span><span id="local-6989586621679082263"><span class="annot"><span class="annottext">minList :: Pos -&gt; ([Tile], Weights, Float) -&gt; (Float, [Pos]) -&gt; (Float, [Pos])
</span><a href="#local-6989586621679082263"><span class="hs-identifier hs-var hs-var">minList</span></a></span></span><span> </span><span id="local-6989586621679082264"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082264"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Tile]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weights
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082265"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082265"><span class="hs-identifier hs-var">entropy</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679082266"><span class="annot"><span class="annottext">(Float, [Pos])
</span><a href="#local-6989586621679082266"><span class="hs-identifier hs-var">list</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Float, [Pos])
</span><a href="#local-6989586621679082266"><span class="hs-identifier hs-var">list</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-165"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082265"><span class="hs-identifier hs-var">entropy</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082264"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679082267"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082267"><span class="hs-identifier hs-var">minEntropy</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082268"><span class="annot"><span class="annottext">[Pos]
</span><a href="#local-6989586621679082268"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082265"><span class="hs-identifier hs-var">entropy</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082267"><span class="hs-identifier hs-var">minEntropy</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082265"><span class="hs-identifier hs-var">entropy</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082264"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082265"><span class="hs-identifier hs-var">entropy</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082267"><span class="hs-identifier hs-var">minEntropy</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082267"><span class="hs-identifier hs-var">minEntropy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082264"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; [Pos] -&gt; [Pos]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Pos]
</span><a href="#local-6989586621679082268"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Float, [Pos])
</span><a href="#local-6989586621679082266"><span class="hs-identifier hs-var">list</span></a></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span class="annot"><span class="hs-comment">-- | Get a random element from a list</span></span><span>
</span><span id="line-172"></span><span id="local-6989586621679081901"><span class="annot"><a href="Gen.WaveFuncCollapse.html#getRandomElement"><span class="hs-identifier hs-type">getRandomElement</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679081901"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679081901"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-173"></span><span id="getRandomElement"><span class="annot"><span class="annottext">getRandomElement :: forall a. [a] -&gt; IO a
</span><a href="Gen.WaveFuncCollapse.html#getRandomElement"><span class="hs-identifier hs-var hs-var">getRandomElement</span></a></span></span><span> </span><span id="local-6989586621679082281"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679082281"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-174"></span><span>  </span><span id="local-6989586621679082282"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082282"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; IO Int
forall a (m :: * -&gt; *). (Random a, MonadIO m) =&gt; (a, a) -&gt; m a
</span><span class="hs-identifier hs-var">randomRIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679082281"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><span class="annottext">a -&gt; IO a
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679082281"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int -&gt; a
forall a. HasCallStack =&gt; [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679082282"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span class="hs-comment">-- | Update the dependencies of a position, where a `Tile` has been placed. The function will remove the position</span><span>
</span><span id="line-178"></span><span class="hs-comment">--   from the dependencies and insert the position of the tile at the position of the dependencies.</span><span>
</span><span id="line-179"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#updateDependencies"><span class="hs-identifier hs-type">updateDependencies</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Internal.Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Dependencies"><span class="hs-identifier hs-type">Dependencies</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Dependencies"><span class="hs-identifier hs-type">Dependencies</span></a></span><span>
</span><span id="line-180"></span><span id="updateDependencies"><span class="annot"><span class="annottext">updateDependencies :: Pos -&gt; Tile -&gt; TileMap -&gt; Dependencies -&gt; Dependencies
</span><a href="Gen.WaveFuncCollapse.html#updateDependencies"><span class="hs-identifier hs-var hs-var">updateDependencies</span></a></span></span><span> </span><span id="local-6989586621679082287"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082287"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621679082288"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082288"><span class="hs-identifier hs-var">tile</span></a></span></span><span> </span><span id="local-6989586621679082289"><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082289"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span> </span><span id="local-6989586621679082290"><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082290"><span class="hs-identifier hs-var">dependencies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Internal.Def.html#Rule"><span class="hs-identifier hs-type">Rule</span></a></span><span> </span><span id="local-6989586621679082291"><span class="annot"><span class="annottext">TileMap -&gt; Pos -&gt; RuleMonad RuleResult
</span><a href="#local-6989586621679082291"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tile -&gt; Rule
</span><a href="Internal.Def.html#rules"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082288"><span class="hs-identifier hs-var">tile</span></a></span><span>
</span><span id="line-182"></span><span>  </span><span id="local-6989586621679082292"><span class="annot"><span class="annottext">deps :: [Pos]
</span><a href="#local-6989586621679082292"><span class="hs-identifier hs-var hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMonad RuleResult -&gt; [Pos]
forall a. RuleMonad a -&gt; [Pos]
</span><a href="Internal.Def.html#getPos"><span class="hs-identifier hs-var">getPos</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleMonad RuleResult -&gt; [Pos]) -&gt; RuleMonad RuleResult -&gt; [Pos]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TileMap -&gt; Pos -&gt; RuleMonad RuleResult
</span><a href="#local-6989586621679082291"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="annot"><span class="annottext">TileMap
</span><a href="#local-6989586621679082289"><span class="hs-identifier hs-var">tileMap</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082287"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(Pos -&gt; Dependencies -&gt; Dependencies)
-&gt; Dependencies -&gt; [Pos] -&gt; Dependencies
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679082294"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082294"><span class="hs-identifier hs-var">pos'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">([Pos] -&gt; [Pos] -&gt; [Pos])
-&gt; Pos -&gt; [Pos] -&gt; Dependencies -&gt; Dependencies
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insertWith</span></span><span> </span><span class="annot"><span class="annottext">[Pos] -&gt; [Pos] -&gt; [Pos]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">(++)</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082294"><span class="hs-identifier hs-var">pos'</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082287"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos -&gt; Dependencies -&gt; Dependencies
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.delete</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082287"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082290"><span class="hs-identifier hs-var">dependencies</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Pos]
</span><a href="#local-6989586621679082292"><span class="hs-identifier hs-var">deps</span></a></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="hs-comment">-- | Collapse the wave function of a single position. Selects a random tile from the environment and</span><span>
</span><span id="line-186"></span><span class="hs-comment">--  adds it to the tileMap. If the environment has no possible tiles, the function will return Nothing.</span><span>
</span><span id="line-187"></span><span class="hs-comment">--  After the tile has been added to the tileMap, the position will be removed from the environment,</span><span>
</span><span id="line-188"></span><span class="hs-comment">--  and the environment will be updated with the new possible tiles.</span><span>
</span><span id="line-189"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#waveFuncCollapseStep"><span class="hs-identifier hs-type">waveFuncCollapseStep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Internal.Def.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Dependencies"><span class="hs-identifier hs-type">Dependencies</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#History"><span class="hs-identifier hs-type">History</span></a></span><span> </span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Dependencies"><span class="hs-identifier hs-type">Dependencies</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#History"><span class="hs-identifier hs-type">History</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span id="waveFuncCollapseStep"><span class="annot"><span class="annottext">waveFuncCollapseStep :: Pos
-&gt; TileMap
-&gt; Env
-&gt; Dependencies
-&gt; [HistoryUnit]
-&gt; IO (Maybe (TileMap, Env, Dependencies), [HistoryUnit])
</span><a href="Gen.WaveFuncCollapse.html#waveFuncCollapseStep"><span class="hs-identifier hs-var hs-var">waveFuncCollapseStep</span></a></span></span><span> </span><span id="local-6989586621679082297"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082297"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-type">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082298"><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082298"><span class="hs-identifier hs-var">tileMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082299"><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082299"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679082300"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082300"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621679082301"><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082301"><span class="hs-identifier hs-var">dependencies</span></a></span></span><span> </span><span id="local-6989586621679082302"><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679082302"><span class="hs-identifier hs-var">history</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082307"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082307"><span class="hs-identifier hs-var">newTiles</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082308"><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679082308"><span class="hs-identifier hs-var">weight</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082300"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Pos -&gt; ([Tile], Weights, Float)
forall k a. Ord k =&gt; Map k a -&gt; k -&gt; a
</span><span class="hs-operator hs-var">M.!</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082297"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-193"></span><span>  </span><span id="local-6989586621679082309"><span class="annot"><span class="annottext">Maybe Tile
</span><a href="#local-6989586621679082309"><span class="hs-identifier hs-var">rTile</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; Weights -&gt; IO (Maybe Tile)
</span><a href="Gen.WaveFuncCollapse.html#randomTile"><span class="hs-identifier hs-var">randomTile</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082307"><span class="hs-identifier hs-var">newTiles</span></a></span><span> </span><span class="annot"><span class="annottext">Weights
</span><a href="#local-6989586621679082308"><span class="hs-identifier hs-var">weight</span></a></span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Tile
</span><a href="#local-6989586621679082309"><span class="hs-identifier hs-var">rTile</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><span class="annottext">Maybe Tile
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe (TileMap, Env, Dependencies), [HistoryUnit])
-&gt; IO (Maybe (TileMap, Env, Dependencies), [HistoryUnit])
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (TileMap, Env, Dependencies)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679082302"><span class="hs-identifier hs-var">history</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679082311"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082311"><span class="hs-identifier hs-var">tile</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><span id="line-197"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679082316"><span class="annot"><span class="annottext">newTileMap :: Map Pos Tile
</span><a href="#local-6989586621679082316"><span class="hs-identifier hs-var hs-var">newTileMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Tile -&gt; Map Pos Tile -&gt; Map Pos Tile
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082297"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082311"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082298"><span class="hs-identifier hs-var">tileMap</span></a></span><span>
</span><span id="line-198"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679082317"><span class="annot"><span class="annottext">newHistory :: [HistoryUnit]
</span><a href="#local-6989586621679082317"><span class="hs-identifier hs-var hs-var">newHistory</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TileMap -&gt; Env -&gt; Dependencies -&gt; Pos -&gt; Tile -&gt; HistoryUnit
</span><a href="Gen.WaveFuncCollapse.html#HistoryUnit"><span class="hs-identifier hs-var">HistoryUnit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082298"><span class="hs-identifier hs-var">tileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082299"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082300"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082301"><span class="hs-identifier hs-var">dependencies</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082297"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082311"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="annot"><span class="annottext">HistoryUnit -&gt; [HistoryUnit] -&gt; [HistoryUnit]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679082302"><span class="hs-identifier hs-var">history</span></a></span><span>
</span><span id="line-199"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679082322"><span class="annot"><span class="annottext">newEnv :: Env
</span><a href="#local-6989586621679082322"><span class="hs-identifier hs-var hs-var">newEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Env -&gt; Env
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.delete</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082297"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082300"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-200"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679082323"><span class="annot"><span class="annottext">newDependencies :: Dependencies
</span><a href="#local-6989586621679082323"><span class="hs-identifier hs-var hs-var">newDependencies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Tile -&gt; TileMap -&gt; Dependencies -&gt; Dependencies
</span><a href="Gen.WaveFuncCollapse.html#updateDependencies"><span class="hs-identifier hs-var">updateDependencies</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679082297"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082311"><span class="hs-identifier hs-var">tile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082316"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082299"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082301"><span class="hs-identifier hs-var">dependencies</span></a></span><span>
</span><span id="line-201"></span><span>      </span><span class="annot"><span class="annottext">(Maybe (TileMap, Env, Dependencies), [HistoryUnit])
-&gt; IO (Maybe (TileMap, Env, Dependencies), [HistoryUnit])
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TileMap
-&gt; Env -&gt; Dependencies -&gt; Maybe (TileMap, Env, Dependencies)
</span><a href="Gen.WaveFuncCollapse.html#updateEnv"><span class="hs-identifier hs-var">updateEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Pos Tile, Size) -&gt; TileMap
</span><a href="Internal.Def.html#TileMap"><span class="hs-identifier hs-var">TileMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Pos Tile
</span><a href="#local-6989586621679082316"><span class="hs-identifier hs-var">newTileMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Size
</span><a href="#local-6989586621679082299"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679082322"><span class="hs-identifier hs-var">newEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Dependencies
</span><a href="#local-6989586621679082323"><span class="hs-identifier hs-var">newDependencies</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[HistoryUnit]
</span><a href="#local-6989586621679082317"><span class="hs-identifier hs-var">newHistory</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="hs-comment">-- | Select a random tile from a list of tiles based on their weights.</span><span>
</span><span id="line-204"></span><span class="hs-comment">--   If the total weight is 0, the function will return Nothing.</span><span>
</span><span id="line-205"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#randomTile"><span class="hs-identifier hs-type">randomTile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Gen.WaveFuncCollapse.html#Weights"><span class="hs-identifier hs-type">Weights</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span id="randomTile"><span class="annot"><span class="annottext">randomTile :: [Tile] -&gt; Weights -&gt; IO (Maybe Tile)
</span><a href="Gen.WaveFuncCollapse.html#randomTile"><span class="hs-identifier hs-var hs-var">randomTile</span></a></span></span><span> </span><span id="local-6989586621679082324"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082324"><span class="hs-identifier hs-var">tiles</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082325"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082325"><span class="hs-identifier hs-var">totalWeight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082326"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082326"><span class="hs-identifier hs-var">tilesWeight</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082325"><span class="hs-identifier hs-var">totalWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0.0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe Tile -&gt; IO (Maybe Tile)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Tile
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>    </span><span id="local-6989586621679082327"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082327"><span class="hs-identifier hs-var">randomNum</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Float, Float) -&gt; IO Float
forall a (m :: * -&gt; *). (Random a, MonadIO m) =&gt; (a, a) -&gt; m a
</span><span class="hs-identifier hs-var">randomRIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">0.0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082325"><span class="hs-identifier hs-var">totalWeight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>    </span><span class="annot"><span class="annottext">Maybe Tile -&gt; IO (Maybe Tile)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Tile -&gt; IO (Maybe Tile)) -&gt; Maybe Tile -&gt; IO (Maybe Tile)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; [Float] -&gt; Float -&gt; Maybe Tile
</span><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var">weightToTile</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082324"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082326"><span class="hs-identifier hs-var">tilesWeight</span></a></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082327"><span class="hs-identifier hs-var">randomNum</span></a></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="hs-comment">-- | Convert a list of tiles and their weights to a single tile based on a random number.</span><span>
</span><span id="line-212"></span><span class="hs-comment">--  The function will return Nothing if list of tiles and weights are empty or the random number is </span><span>
</span><span id="line-213"></span><span class="hs-comment">--  greater than the total weight. The length of the tiles and weights must be the same.</span><span>
</span><span id="line-214"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-type">weightToTile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Float</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Internal.Def.html#Tile"><span class="hs-identifier hs-type">Tile</span></a></span><span>
</span><span id="line-215"></span><span id="weightToTile"><span class="annot"><span class="annottext">weightToTile :: [Tile] -&gt; [Float] -&gt; Float -&gt; Maybe Tile
</span><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var hs-var">weightToTile</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Tile
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-216"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var">weightToTile</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082329"><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082329"><span class="hs-identifier hs-var">tile</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679082330"><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082330"><span class="hs-identifier hs-var">tiles</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082331"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082331"><span class="hs-identifier hs-var">weight</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679082332"><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082332"><span class="hs-identifier hs-var">weights</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679082333"><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082333"><span class="hs-identifier hs-var">randomNum</span></a></span></span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082333"><span class="hs-identifier hs-var">randomNum</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082331"><span class="hs-identifier hs-var">weight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tile -&gt; Maybe Tile
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Tile
</span><a href="#local-6989586621679082329"><span class="hs-identifier hs-var">tile</span></a></span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Tile] -&gt; [Float] -&gt; Float -&gt; Maybe Tile
</span><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var">weightToTile</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><a href="#local-6989586621679082330"><span class="hs-identifier hs-var">tiles</span></a></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><a href="#local-6989586621679082332"><span class="hs-identifier hs-var">weights</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082333"><span class="hs-identifier hs-var">randomNum</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><a href="#local-6989586621679082331"><span class="hs-identifier hs-var">weight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span class="annot"><a href="Gen.WaveFuncCollapse.html#weightToTile"><span class="hs-identifier hs-var">weightToTile</span></a></span><span> </span><span class="annot"><span class="annottext">[Tile]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Float]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Float
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Error -&gt; Maybe Tile
forall a. HasCallStack =&gt; Error -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">Error
</span><span class="hs-string">&quot;WeightToTile: tiles and weights are not the same length&quot;</span></span><span>
</span><span id="line-220"></span></pre></body></html>